<!DOCTYPE html>
<html lang="ar" dir="rtl" class="h-full">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ø®ØªØ¨Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>
<script src="https://cdn.tailwindcss.com/3.4.17"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*{font-family:'Noto Kufi Arabic',sans-serif;box-sizing:border-box}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:3px}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
@keyframes sup{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes sdn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
@keyframes sci{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}
@keyframes shk{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
@keyframes cel{0%,100%{transform:scale(1)}50%{transform:scale(1.12) rotate(3deg)}}
@keyframes cff{0%{transform:translateY(-100vh) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
@keyframes tpls{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
@keyframes ren{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
@keyframes pgl{0%,100%{filter:brightness(1)}50%{filter:brightness(1.3)}}
@keyframes wpl{0%,100%{opacity:.5}50%{opacity:1}}
.af{animation:float 3s ease-in-out infinite}.asu{animation:sup .5s ease-out both}.asd{animation:sdn .4s ease-out both}
.asi{animation:sci .35s ease-out both}.ash{animation:shk .4s ease}.ace{animation:cel .5s ease}
.atp{animation:tpls .5s ease-in-out infinite}.are{animation:ren .4s ease-out both}
.apg{animation:pgl 1.5s ease-in-out infinite}.awp{animation:wpl 1.5s ease-in-out infinite}
.cg{background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.02));backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,.12)}
.ob{transition:all .2s ease;position:relative;overflow:hidden}
.ob:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 30px -8px rgba(0,0,0,.4)}
.pt{transition:width .4s ease-out}
.cf{position:fixed;width:10px;height:10px;top:-20px;z-index:100;animation:cff 3s linear forwards}
.qb{background:#fff;padding:14px;border-radius:14px;display:inline-block}
.pc{transition:all .3s ease;cursor:pointer}.pc:hover:not(.used){transform:translateY(-3px)}
.pc.used{opacity:.3;cursor:not-allowed;filter:grayscale(1);pointer-events:none}
.bm{background:radial-gradient(ellipse at 20% 50%,rgba(120,0,255,.25) 0%,transparent 50%),radial-gradient(ellipse at 80% 20%,rgba(255,0,150,.2) 0%,transparent 50%),radial-gradient(ellipse at 50% 80%,rgba(0,200,255,.15) 0%,transparent 50%),linear-gradient(160deg,#0f0326,#1a0a2e 30%,#16082a 60%,#0d0420)}
.sd{width:8px;height:8px;border-radius:50%;display:inline-block;background:#34d399;box-shadow:0 0 6px #34d399}
.opt-hidden{opacity:.12!important;pointer-events:none!important;transform:scale(.95)!important}
.inp{width:100%;padding:10px 14px;border-radius:12px;background:rgba(255,255,255,.08);color:#fff;border:1px solid rgba(255,255,255,.15);outline:none;font-size:.95rem}
.inp:focus{border-color:#a855f7}
.inp::placeholder{color:rgba(255,255,255,.3)}
.btn-p{padding:10px 24px;border-radius:12px;background:linear-gradient(135deg,#a855f7,#ec4899);color:#fff;font-weight:700;border:none;cursor:pointer;transition:all .2s}
.btn-p:hover{transform:scale(1.03);box-shadow:0 4px 20px rgba(168,85,247,.4)}
.btn-p:disabled{opacity:.4;cursor:not-allowed;transform:none}
.btn-s{padding:8px 20px;border-radius:10px;background:rgba(255,255,255,.08);color:#d8b4fe;border:1px solid rgba(255,255,255,.12);cursor:pointer;transition:all .2s}
.btn-s:hover{background:rgba(255,255,255,.15)}
.btn-d{padding:6px 14px;border-radius:8px;background:rgba(239,68,68,.2);color:#fca5a5;border:none;cursor:pointer;font-size:.8rem}
.btn-d:hover{background:rgba(239,68,68,.4)}
.badge{display:inline-block;padding:2px 10px;border-radius:20px;font-size:.75rem;font-weight:600}
.tab-btn{padding:8px 20px;border-radius:10px;cursor:pointer;transition:all .2s;font-weight:600;font-size:.9rem}
.tab-btn.active{background:linear-gradient(135deg,#a855f7,#ec4899);color:#fff}
.tab-btn:not(.active){background:rgba(255,255,255,.06);color:#d8b4fe}
</style>
</head>
<body class="h-full overflow-auto bm">

<!-- LOADING -->
<div id="scr-loading" class="min-h-full flex flex-col items-center justify-center p-6"><div class="text-center asi"><div class="text-8xl mb-6 af">ğŸ¤–</div><h1 class="text-4xl font-black text-white mb-4">Ø§Ø®ØªØ¨Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h1><div class="flex items-center justify-center gap-2"><div class="w-3 h-3 rounded-full bg-purple-400 awp"></div><div class="w-3 h-3 rounded-full bg-pink-400 awp" style="animation-delay:.2s"></div><div class="w-3 h-3 rounded-full bg-cyan-400 awp" style="animation-delay:.4s"></div></div><p class="text-purple-300 mt-4" id="load-txt">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</p></div></div>

<!-- ROLE SELECT -->
<div id="scr-role" class="hidden min-h-full flex flex-col items-center justify-center p-6"><div class="text-center max-w-2xl w-full"><div class="text-9xl mb-4 af">ğŸ¤–</div><h1 class="text-4xl md:text-5xl font-black text-white mb-2 asu">Ø§Ø®ØªØ¨Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h1><p class="text-lg text-purple-300 mb-10 asu" style="animation-delay:.1s">Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù„Ù…ÙŠ â€¢ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ± â€¢ Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</p><div class="grid grid-cols-1 md:grid-cols-3 gap-5"><div onclick="scr('scr-admin-login')" class="cg rounded-3xl p-7 cursor-pointer hover:scale-105 transition-all hover:bg-white/10 asu" style="animation-delay:.15s"><div class="text-6xl mb-3">ğŸ‘¨â€ğŸ«</div><h2 class="text-xl font-bold text-white mb-1">Ø§Ù„Ù…Ù†Ø¸Ù…</h2><p class="text-purple-300 text-sm">Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ­ÙƒÙ… ÙƒØ§Ù…Ù„</p></div><div onclick="pickRole('player')" class="cg rounded-3xl p-7 cursor-pointer hover:scale-105 transition-all hover:bg-white/10 asu" style="animation-delay:.25s"><div class="text-6xl mb-3">ğŸ®</div><h2 class="text-xl font-bold text-white mb-1">Ù„Ø§Ø¹Ø¨</h2><p class="text-purple-300 text-sm">Ø§Ù†Ø¶Ù… ÙˆØ£Ø¬Ø¨</p></div><div onclick="scr('scr-instructions')" class="cg rounded-3xl p-7 cursor-pointer hover:scale-105 transition-all hover:bg-white/10 asu" style="animation-delay:.35s"><div class="text-6xl mb-3">ğŸ“–</div><h2 class="text-xl font-bold text-white mb-1">Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</h2><p class="text-purple-300 text-sm">ÙƒÙŠÙ ØªÙ„Ø¹Ø¨ØŸ</p></div></div></div></div>

<!-- INSTRUCTIONS -->
<div id="scr-instructions" class="hidden min-h-full flex flex-col items-center p-6 pt-8"><div class="max-w-2xl w-full"><div class="text-center mb-8"><div class="text-7xl mb-3">ğŸ“–</div><h2 class="text-3xl font-black text-white asd">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2></div><div class="cg rounded-2xl p-6 mb-4 asu"><h3 class="text-white font-bold text-lg mb-3">ğŸš€ ÙƒÙŠÙ ØªØ¨Ø¯Ø£ØŸ</h3><p class="text-purple-300 text-sm mb-2">â€¢ <strong class="text-white">Ø§Ù„Ù…Ù†Ø¸Ù…</strong> ÙŠÙ†Ø´Ø¦ Ø­Ø³Ø§Ø¨ ÙˆÙŠØ¶Ø¨Ø· Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ø²Ù…Ù† Ø«Ù… ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</p><p class="text-purple-300 text-sm">â€¢ <strong class="text-white">Ø§Ù„Ù„Ø§Ø¹Ø¨</strong> ÙŠÙ†Ø¶Ù… Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ QR ÙˆÙŠØ¬ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</p></div><div class="cg rounded-2xl p-6 mb-4 asu" style="animation-delay:.1s"><h3 class="text-white font-bold text-lg mb-3">ğŸ¯ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù„Ø¹Ø¨</h3><p class="text-purple-300 text-sm mb-2">â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙŠØ¬ÙŠØ¨ÙˆÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª</p><p class="text-purple-300 text-sm mb-2">â€¢ Ø§Ù„Ù†Ù‚Ø§Ø· Ø«Ø§Ø¨ØªØ© Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„ (ÙŠØ­Ø¯Ø¯Ù‡Ø§ Ø§Ù„Ù…Ù†Ø¸Ù…)</p><p class="text-purple-300 text-sm">â€¢ Ø§Ù„Ù†Ù‚Ø§Ø· ØªØ±Ø§ÙƒÙ…ÙŠØ© Ø·ÙˆØ§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©</p></div><div class="cg rounded-2xl p-6 mb-4 asu" style="animation-delay:.15s"><h3 class="text-white font-bold text-lg mb-3">âš¡ Ø§Ù„Ù‚ÙˆÙ‰ Ø§Ù„Ø®Ø§ØµØ© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)</h3><p class="text-purple-300 text-sm mb-2">â±ï¸ <strong class="text-white">ØªÙ…Ø¯ÙŠØ¯ Ø§Ù„ÙˆÙ‚Øª</strong> +10 Ø«ÙˆØ§Ù†ÙŠ</p><p class="text-purple-300 text-sm mb-2">âœ¨ <strong class="text-white">Ø¥Ø¬Ø§Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</strong> ØªØ¬ÙŠØ¨ ØµØ­ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p><p class="text-purple-300 text-sm">ğŸš« <strong class="text-white">50/50</strong> Ø­Ø°Ù Ø®ÙŠØ§Ø±ÙŠÙ† Ø®Ø§Ø·Ø¦ÙŠÙ†</p></div><div class="cg rounded-2xl p-6 mb-8 asu" style="animation-delay:.2s"><h3 class="text-white font-bold text-lg mb-3">ğŸ† Ø§Ù„ØªØ±ØªÙŠØ¨</h3><p class="text-purple-300 text-sm mb-2">1ï¸âƒ£ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· (ØªØ±Ø§ÙƒÙ…ÙŠØ©)</p><p class="text-purple-300 text-sm">2ï¸âƒ£ Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø§ÙˆÙŠ: Ø§Ù„Ø£Ø³Ø±Ø¹ Ø²Ù…Ù†Ø§Ù‹ ÙŠØªÙ‚Ø¯Ù… (Ø§Ù„Ø²Ù…Ù† ÙŠØ­Ø³Ø¨ ÙÙ‚Ø· Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©)</p></div><div class="text-center"><button onclick="scr('scr-role')" class="btn-p text-lg px-12 py-3">ğŸ‘ ÙÙ‡Ù…Øª!</button></div></div></div>

<!-- ADMIN LOGIN -->
<div id="scr-admin-login" class="hidden min-h-full flex flex-col items-center justify-center p-6"><div class="max-w-md w-full"><div class="text-center mb-6"><div class="text-6xl mb-2">ğŸ”</div><h2 class="text-3xl font-bold text-white">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¸Ù…</h2></div><div class="cg rounded-3xl p-8 asi"><div class="flex gap-2 mb-6 justify-center"><button id="tab-login" onclick="setAuthTab('login')" class="tab-btn active">Ø¯Ø®ÙˆÙ„</button><button id="tab-reg" onclick="setAuthTab('register')" class="tab-btn">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button></div><div id="auth-reg-fields" class="hidden mb-4"><label class="text-white text-sm block mb-1">Ø§Ù„Ø§Ø³Ù…</label><input id="a-dname" type="text" class="inp mb-3" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„"></div><div class="mb-4"><label class="text-white text-sm block mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input id="a-user" type="text" class="inp" placeholder="admin"></div><div class="mb-5"><label class="text-white text-sm block mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="a-pass" type="password" class="inp" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div><button onclick="doAuth()" class="btn-p w-full py-3 text-lg" id="auth-btn">Ø¯Ø®ÙˆÙ„</button><p id="auth-msg" class="text-sm mt-3 min-h-[20px] text-center"></p></div><div class="text-center mt-4"><button onclick="scr('scr-role')" class="btn-s">â† Ø±Ø¬ÙˆØ¹</button></div></div></div>

<!-- ADMIN DASHBOARD -->
<div id="scr-dashboard" class="hidden min-h-full flex flex-col p-4 md:p-6"><div class="max-w-4xl mx-auto w-full">
<div class="flex items-center justify-between mb-6 flex-wrap gap-3"><div><h2 class="text-2xl font-bold text-white asd">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ù†Ø¸Ù…</h2><p id="dash-welcome" class="text-purple-300 text-sm"></p></div><div class="flex gap-2"><button onclick="adminLogout()" class="btn-s text-xs">ğŸšª Ø®Ø±ÙˆØ¬</button></div></div>

<!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ -->
<div class="cg rounded-2xl p-6 mb-6 asu"><div class="flex items-center justify-between mb-4"><h3 class="text-white font-bold text-lg">ğŸ® Ø£Ù„Ø¹Ø§Ø¨ÙŠ</h3><button onclick="createNewGame()" class="btn-p text-sm">+ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button></div><div id="games-list" class="space-y-3"><p class="text-purple-400 text-sm text-center py-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div></div>
</div></div>

<!-- GAME EDITOR -->
<div id="scr-editor" class="hidden min-h-full flex flex-col p-4 md:p-6"><div class="max-w-4xl mx-auto w-full">
<div class="flex items-center justify-between mb-6 flex-wrap gap-3"><h2 class="text-2xl font-bold text-white asd">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2><div class="flex gap-2"><button onclick="loadDashboard()" class="btn-s text-xs">â† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</button><button onclick="saveGameSettings()" class="btn-p text-sm" id="save-btn">ğŸ’¾ Ø­ÙØ¸</button></div></div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
<div class="cg rounded-2xl p-5 asu"><label class="text-white text-sm font-semibold block mb-2">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù„Ø¹Ø¨Ø©</label><input id="ge-title" class="inp" placeholder="Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ"></div>
<div class="cg rounded-2xl p-5 asu" style="animation-delay:.05s"><label class="text-white text-sm font-semibold block mb-2">Ø§Ù„Ù†Ù‚Ø§Ø· Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„</label><input id="ge-points" type="number" class="inp" min="1" max="1000" value="10"></div>
<div class="cg rounded-2xl p-5 asu" style="animation-delay:.1s"><label class="text-white text-sm font-semibold block mb-2">Ø§Ù„Ø²Ù…Ù† Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„ (Ø«ÙˆØ§Ù†ÙŠ)</label><input id="ge-time" type="number" class="inp" min="5" max="120" value="20"></div>
<div class="cg rounded-2xl p-5 asu" style="animation-delay:.15s"><label class="text-white text-sm font-semibold block mb-2">Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="ge-status" class="inp"><option value="draft">Ù…Ø³ÙˆØ¯Ø©</option><option value="active">Ù†Ø´Ø·Ø©</option><option value="ended">Ù…Ù†ØªÙ‡ÙŠØ©</option></select></div>
<div class="cg rounded-2xl p-5 asu" style="animation-delay:.2s"><label class="text-white text-sm font-semibold block mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label><input id="ge-from" type="datetime-local" class="inp"></div>
<div class="cg rounded-2xl p-5 asu" style="animation-delay:.25s"><label class="text-white text-sm font-semibold block mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input id="ge-to" type="datetime-local" class="inp"></div>
</div>

<!-- Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
<div class="cg rounded-2xl p-6 mb-6 asu" style="animation-delay:.3s"><div class="flex items-center justify-between mb-4"><h3 class="text-white font-bold text-lg">ğŸ“ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© <span id="q-count-badge" class="badge bg-purple-500/30 text-purple-300 mr-2">0</span></h3><button onclick="addQuestion()" class="btn-p text-sm">+ Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</button></div><div id="questions-editor" class="space-y-4"></div></div>

<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ -->
<div class="cg rounded-2xl p-6 mb-6 asu" style="animation-delay:.35s"><h3 class="text-white font-bold text-lg mb-4">ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</h3><div class="flex items-center gap-4 flex-wrap"><button onclick="startHosting()" class="btn-p text-lg px-10 py-3" id="host-game-btn">â–¶ï¸ Ø§Ø¨Ø¯Ø£ ÙƒÙ…Ø¶ÙŠÙ</button><p class="text-purple-400 text-sm">Ø§Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ø¨Ø¯Ø£</p></div></div>
</div></div>

<!-- HOST LOBBY -->
<div id="scr-host-lobby" class="hidden min-h-full flex flex-col items-center p-6 pt-8"><div class="text-center max-w-3xl w-full"><h2 class="text-3xl font-bold text-white mb-2 asd" id="hl-title">ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨Ø©</h2><p id="hl-info" class="text-purple-300 text-sm mb-6"></p><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"><div class="cg rounded-2xl p-6 asu"><p class="text-purple-300 text-sm mb-2">ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</p><div id="h-code" class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-pink-400 tracking-[.3em] my-3">0000</div><button onclick="navigator.clipboard.writeText(GC)" class="btn-s text-sm">ğŸ“‹ Ù†Ø³Ø®</button></div><div class="cg rounded-2xl p-6 asu flex flex-col items-center"><p class="text-purple-300 text-sm mb-3">QR</p><div id="qr-box" class="qb"></div></div></div><div class="cg rounded-2xl p-6 mb-6 asu"><div class="flex items-center justify-between mb-4"><h3 class="text-white font-bold">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†</h3><span id="h-count" class="badge bg-purple-500/30 text-purple-300">0</span></div><div id="h-players" class="max-h-64 overflow-y-auto space-y-2"><p class="text-purple-400 text-sm text-center py-4 awp">â³ Ø§Ù†ØªØ¸Ø§Ø±...</p></div></div><button id="h-start-btn" onclick="hostSendStart()" disabled class="btn-p text-xl px-14 py-4">â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button><br><button onclick="loadDashboard()" class="btn-s mt-4">â† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button></div></div>

<!-- HOST GAME -->
<div id="scr-host-game" class="hidden min-h-full flex flex-col p-4 md:p-6"><div class="flex flex-wrap items-center justify-between gap-3 mb-4"><div class="cg px-4 py-2 rounded-xl"><span class="text-purple-300 text-xs">Ø§Ù„Ø³Ø¤Ø§Ù„ </span><span id="hg-qnum" class="text-white font-bold text-lg"></span></div><div class="cg px-4 py-2 rounded-xl"><span class="text-purple-300 text-xs">Ù†Ù‚Ø§Ø·: </span><span id="hg-pts" class="text-amber-400 font-bold"></span></div><div class="cg rounded-xl p-1"><div id="hg-timer-box" class="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center"><span id="hg-timer" class="text-white font-black text-2xl">20</span></div></div></div><div class="w-full h-2 bg-white/10 rounded-full mb-4 overflow-hidden"><div id="hg-prog" class="pt h-full rounded-full bg-gradient-to-r from-purple-500 via-pink-500 to-amber-400" style="width:5%"></div></div><div class="flex-1 flex flex-col items-center justify-center"><div class="cg rounded-3xl p-6 md:p-10 w-full max-w-3xl mb-6 asi"><h2 id="hg-qtxt" class="text-xl md:text-3xl font-bold text-white text-center leading-relaxed"></h2></div><div id="hg-opts" class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-3xl mb-6"></div><div class="cg rounded-2xl p-4 w-full max-w-3xl"><div class="flex items-center justify-between mb-2"><span class="text-purple-300 text-sm">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</span><span id="hg-ans-count" class="text-white font-bold text-xl">0/0</span></div><div class="w-full h-3 bg-white/10 rounded-full overflow-hidden"><div id="hg-ans-bar" class="pt h-full rounded-full bg-gradient-to-r from-emerald-400 to-teal-500" style="width:0%"></div></div></div></div><div class="mt-6 text-center"><button id="hg-next-btn" onclick="hostNextQ()" class="hidden btn-p text-xl px-12 py-4">â–¶ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button><button id="hg-show-btn" onclick="hostShowLB()" class="hidden btn-s text-lg px-10 py-3 mr-3">ğŸ“Š Ø§Ù„ØªØ±ØªÙŠØ¨</button></div></div>

<!-- HOST MID LB -->
<div id="scr-host-mid" class="hidden min-h-full flex flex-col items-center justify-center p-6"><div class="text-center max-w-2xl w-full"><h2 class="text-3xl font-bold text-white mb-2 asd">ğŸ“Š Ø§Ù„ØªØ±ØªÙŠØ¨</h2><p id="hm-info" class="text-purple-300 mb-6"></p><div id="hm-ranks" class="cg rounded-2xl p-4 mb-8 space-y-2"></div><button onclick="hostNextQ()" class="btn-p text-xl px-12 py-4">â–¶ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button></div></div>

<!-- PLAYER JOIN -->
<div id="scr-join" class="hidden min-h-full flex flex-col items-center justify-center p-6"><div class="max-w-md w-full"><div class="text-center mb-6"><div class="text-6xl mb-2">ğŸ‘¤</div><h2 class="text-3xl font-bold text-white">Ø§Ù†Ø¶Ù… Ù„Ù„Ø¹Ø¨Ø©</h2></div><div class="cg rounded-3xl p-8 asi"><div class="mb-4"><label class="text-white text-sm block mb-1">Ø§Ø³Ù…Ùƒ</label><input id="inp-name" type="text" maxlength="20" class="inp text-lg" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ"></div><div class="mb-5"><label class="text-white text-sm block mb-1">ÙƒÙˆØ¯ Ø§Ù„Ù„Ø¹Ø¨Ø©</label><input id="inp-code" type="text" maxlength="4" class="inp text-center text-3xl font-bold tracking-[.4em]" placeholder="0000"></div><button onclick="joinGame()" class="btn-p w-full py-3 text-lg mb-3">ğŸš€ Ø¯Ø®ÙˆÙ„</button><div class="text-center text-purple-400 text-sm my-3">â€” Ø£Ùˆ â€”</div><button onclick="openQR()" class="w-full py-3 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-500 text-white font-bold text-lg">ğŸ“± Ù…Ø³Ø­ QR</button><p id="join-msg" class="text-sm mt-3 min-h-[20px] text-center"></p></div><div class="text-center mt-4"><button onclick="goHome()" class="btn-s">â† Ø±Ø¬ÙˆØ¹</button></div></div><video id="qr-video" class="hidden fixed inset-0 z-50 object-cover w-full h-full" playsinline autoplay></video><div id="qr-overlay" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/80"><div class="w-64 h-64 border-4 border-white/50 rounded-2xl mb-6"></div><p class="text-white text-lg mb-4">ğŸ“· QR</p><button onclick="closeQR()" class="px-8 py-3 rounded-xl bg-red-500 text-white font-bold">âœ•</button></div></div>

<!-- PLAYER WAIT/Q/WAIT-NEXT -->
<div id="scr-wait" class="hidden min-h-full flex flex-col items-center justify-center p-6"><div class="text-center asi"><div class="text-8xl mb-6 af">âœ…</div><h2 class="text-3xl font-bold text-white mb-3">ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…!</h2><p class="text-purple-300 text-lg awp">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...</p><p id="w-name" class="text-white font-bold text-xl mt-4"></p></div></div>

<div id="scr-player-q" class="hidden min-h-full flex flex-col p-4 md:p-6"><div class="flex flex-wrap items-center justify-between gap-3 mb-4"><div class="cg px-4 py-2 rounded-xl"><span class="text-purple-300 text-xs">Ø§Ù„Ø³Ø¤Ø§Ù„ </span><span id="pq-num" class="text-white font-bold text-lg"></span></div><div class="cg px-4 py-2 rounded-xl"><span id="pq-score" class="text-amber-400 font-bold">0</span></div><div class="cg rounded-xl p-1"><div id="pq-timer-box" class="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center"><span id="pq-timer" class="text-white font-black text-2xl">20</span></div></div></div><div class="w-full h-2 bg-white/10 rounded-full mb-4 overflow-hidden"><div id="pq-prog" class="pt h-full rounded-full bg-gradient-to-r from-purple-500 via-pink-500 to-amber-400" style="width:5%"></div></div><div id="pq-powers" class="flex justify-center gap-3 mb-4 flex-wrap"><button onclick="usePW('extend')" id="pw-extend" class="pc cg rounded-xl px-3 py-2 flex items-center gap-1 apg"><span>â±ï¸</span><span class="text-white text-sm">+10Ø«</span></button><button onclick="usePW('auto')" id="pw-auto" class="pc cg rounded-xl px-3 py-2 flex items-center gap-1 apg"><span>âœ¨</span><span class="text-white text-sm">ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</span></button><button onclick="usePW('eliminate')" id="pw-eliminate" class="pc cg rounded-xl px-3 py-2 flex items-center gap-1 apg"><span>ğŸš«</span><span class="text-white text-sm">50/50</span></button></div><div class="flex-1 flex flex-col items-center justify-center"><div class="cg rounded-3xl p-6 md:p-10 w-full max-w-3xl mb-6 asi"><h2 id="pq-txt" class="text-xl md:text-3xl font-bold text-white text-center leading-relaxed"></h2></div><div id="pq-opts" class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-3xl"></div></div><div id="pq-result" class="hidden fixed inset-0 flex items-center justify-center bg-black/60 z-50"><div id="pq-res-card" class="cg rounded-3xl p-8 text-center transform scale-0 transition-transform duration-300"><div id="pq-res-emoji" class="text-8xl mb-3"></div><p id="pq-res-txt" class="text-2xl font-bold text-white"></p><p id="pq-res-pts" class="text-lg text-purple-300 mt-2"></p></div></div></div>

<div id="scr-player-wait-next" class="hidden min-h-full flex flex-col items-center justify-center p-6"><div class="text-center asi"><div class="text-6xl mb-4 awp">â³</div><h2 class="text-2xl font-bold text-white mb-2">Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ...</h2><p class="text-purple-300">Ù†ØªÙŠØ¬ØªÙƒ: <span id="pwn-score" class="text-amber-400 font-bold text-xl">0</span></p><p class="text-purple-400 text-sm mt-1">ØµØ­ÙŠØ­Ø©: <span id="pwn-correct" class="text-emerald-400 font-bold">0</span></p></div></div>

<!-- FINAL -->
<div id="scr-final" class="hidden min-h-full flex flex-col items-center justify-center p-6"><div class="text-center max-w-2xl w-full"><div class="text-9xl mb-4 af">ğŸ†</div><h2 class="text-5xl font-black text-white mb-2 asd">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h2><p class="text-purple-300 text-lg mb-8">Ù…Ø¨Ø±ÙˆÙƒ!</p><div id="fin-podium" class="flex items-end justify-center gap-4 mb-8 asu"></div><div id="fin-ranks" class="cg rounded-2xl p-4 mb-8 space-y-2"></div><button onclick="goHome()" class="btn-p text-xl px-12 py-4">ğŸ”„ Ø¬Ø¯ÙŠØ¯Ø©</button></div></div>

<div id="confetti-box" class="fixed inset-0 pointer-events-none z-[200]"></div>
<script>
var SB_URL='https://xsutqujynlgeytzfoqbs.supabase.co',SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzdXRxdWp5bmxnZXl0emZvcWJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzODc0NzUsImV4cCI6MjA4Njk2MzQ3NX0.crGJYQfuRO8282TuP-o6S9H0rsgToAWHHnOOb3a6RnI';
var OC=['from-rose-500 to-pink-600','from-blue-500 to-indigo-600','from-emerald-500 to-teal-600','from-amber-500 to-orange-600'];
var sb,GC='',isHost=false,myName='',myId=null,myScore=0,myCC=0,myTT=0,myPW={extend:false,auto:false,eliminate:false};
var qi=0,tl=20,tmr=null,pAns=false,ac=null,totalPlayers=0,answeredCount=0,hostTimerDone=false;
var hostPollLobby=null,hostPollAnswers=null,playerPollState=null;
var adminId=null,adminName='',curGameId=null,curGameData=null,gameQuestions=[];
var GAMETIME=20,GAMEPOINTS=10;
var SCRS=['scr-loading','scr-role','scr-instructions','scr-admin-login','scr-dashboard','scr-editor','scr-host-lobby','scr-host-game','scr-host-mid','scr-join','scr-wait','scr-player-q','scr-player-wait-next','scr-final'];
function scr(id){SCRS.forEach(function(s){document.getElementById(s).classList.add('hidden')});document.getElementById(id).classList.remove('hidden');scrollTo(0,0)}
function clearAll(){[hostPollLobby,hostPollAnswers,playerPollState,tmr].forEach(function(i){if(i)clearInterval(i)});hostPollLobby=hostPollAnswers=playerPollState=tmr=null}

window.addEventListener('load',async function(){scr('scr-loading');try{sb=window.supabase.createClient(SB_URL,SB_KEY);var r=await sb.from('quiz_players').select('id').limit(1);if(r.error)throw r.error;document.getElementById('load-txt').textContent='âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„!';await new Promise(function(r){setTimeout(r,400)});var jc=new URLSearchParams(location.search).get('join');if(jc){scr('scr-join');document.getElementById('inp-code').value=jc}else scr('scr-role')}catch(e){document.getElementById('load-txt').innerHTML='<span class="text-red-400">âŒ '+(e.message||'')+'</span><br><button onclick="location.reload()" class="btn-p mt-3">ğŸ”„</button>'}});
function pickRole(r){if(r==='player')scr('scr-join')}

// === AUTH ===
var authMode='login';
function setAuthTab(m){authMode=m;document.getElementById('tab-login').className='tab-btn'+(m==='login'?' active':'');document.getElementById('tab-reg').className='tab-btn'+(m==='register'?' active':'');document.getElementById('auth-reg-fields').classList.toggle('hidden',m==='login');document.getElementById('auth-btn').textContent=m==='login'?'Ø¯Ø®ÙˆÙ„':'ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯'}
async function doAuth(){
  var u=document.getElementById('a-user').value.trim(),p=document.getElementById('a-pass').value.trim(),m=document.getElementById('auth-msg');
  if(!u||!p){m.className='text-sm mt-3 min-h-[20px] text-center text-red-400';m.textContent='âŒ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';return}
  if(authMode==='register'){var dn=document.getElementById('a-dname').value.trim();if(!dn){m.className='text-sm mt-3 min-h-[20px] text-center text-red-400';m.textContent='âŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…';return}
    var r=await sb.from('quiz_admins').insert({username:u,password:p,display_name:dn}).select().single();
    if(r.error){m.className='text-sm mt-3 min-h-[20px] text-center text-red-400';m.textContent=r.error.message.includes('duplicate')?'âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯':'âŒ '+r.error.message;return}
    adminId=r.data.id;adminName=r.data.display_name;loadDashboard()
  }else{var r=await sb.from('quiz_admins').select('*').eq('username',u).eq('password',p).single();
    if(r.error||!r.data){m.className='text-sm mt-3 min-h-[20px] text-center text-red-400';m.textContent='âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©';return}
    adminId=r.data.id;adminName=r.data.display_name;loadDashboard()}}
function adminLogout(){adminId=null;adminName='';scr('scr-role')}

// === DASHBOARD ===
async function loadDashboard(){scr('scr-dashboard');document.getElementById('dash-welcome').textContent='Ù…Ø±Ø­Ø¨Ø§Ù‹ '+adminName;
  var r=await sb.from('quiz_games').select('*').eq('admin_id',adminId).order('created_at',{ascending:false});var games=r.data||[];var el=document.getElementById('games-list');
  if(!games.length){el.innerHTML='<p class="text-purple-400 text-sm text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù„Ø¹Ø§Ø¨ Ø¨Ø¹Ø¯</p>';return}
  el.innerHTML=games.map(function(g){var st=g.status==='active'?'bg-emerald-500/20 text-emerald-300':g.status==='draft'?'bg-yellow-500/20 text-yellow-300':'bg-red-500/20 text-red-300';var sl=g.status==='active'?'Ù†Ø´Ø·Ø©':g.status==='draft'?'Ù…Ø³ÙˆØ¯Ø©':'Ù…Ù†ØªÙ‡ÙŠØ©';return '<div class="flex items-center justify-between p-4 rounded-xl bg-white/5 hover:bg-white/8 transition-all cursor-pointer" onclick="openEditor(\''+g.id+'\')"><div><p class="text-white font-bold">'+g.title+'</p><div class="flex gap-3 mt-1"><span class="badge '+st+'">'+sl+'</span><span class="text-purple-400 text-xs">'+g.points_per_question+' Ù†Ù‚Ø·Ø©/Ø³Ø¤Ø§Ù„</span><span class="text-purple-400 text-xs">'+g.time_per_question+'Ø«</span><span class="text-purple-400 text-xs">ÙƒÙˆØ¯: '+g.game_code+'</span></div></div><span class="text-purple-400">â†</span></div>'}).join('')}
async function createNewGame(){var code=String(Math.floor(1000+Math.random()*9000));var r=await sb.from('quiz_games').insert({admin_id:adminId,game_code:code,title:'Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©',points_per_question:10,time_per_question:20,status:'draft'}).select().single();if(!r.error)openEditor(r.data.id)}

// === EDITOR ===
async function openEditor(gid){curGameId=gid;scr('scr-editor');
  var r=await sb.from('quiz_games').select('*').eq('id',gid).single();curGameData=r.data;
  document.getElementById('ge-title').value=r.data.title;document.getElementById('ge-points').value=r.data.points_per_question;document.getElementById('ge-time').value=r.data.time_per_question;document.getElementById('ge-status').value=r.data.status;
  if(r.data.active_from)document.getElementById('ge-from').value=r.data.active_from.slice(0,16);if(r.data.active_to)document.getElementById('ge-to').value=r.data.active_to.slice(0,16);
  loadQuestions()}
async function loadQuestions(){var r=await sb.from('quiz_questions').select('*').eq('game_id',curGameId).order('sort_order',{ascending:true});gameQuestions=r.data||[];renderQuestions()}
function renderQuestions(){var el=document.getElementById('questions-editor');document.getElementById('q-count-badge').textContent=gameQuestions.length;
  if(!gameQuestions.length){el.innerHTML='<p class="text-purple-400 text-sm text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© - Ø£Ø¶Ù Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹</p>';return}
  el.innerHTML=gameQuestions.map(function(q,i){return '<div class="cg rounded-xl p-4" id="qe-'+q.id+'"><div class="flex items-center justify-between mb-3"><span class="badge bg-purple-500/30 text-purple-300">Ø³Ø¤Ø§Ù„ '+(i+1)+'</span><button onclick="deleteQuestion(\''+q.id+'\')" class="btn-d">ğŸ—‘ï¸ Ø­Ø°Ù</button></div><input class="inp mb-2" value="'+esc(q.question_text)+'" onchange="updateQ(\''+q.id+'\',\'question_text\',this.value)" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„"><div class="grid grid-cols-2 gap-2 mb-2"><input class="inp text-sm" value="'+esc(q.option_a)+'" onchange="updateQ(\''+q.id+'\',\'option_a\',this.value)" placeholder="Ø£"><input class="inp text-sm" value="'+esc(q.option_b)+'" onchange="updateQ(\''+q.id+'\',\'option_b\',this.value)" placeholder="Ø¨"><input class="inp text-sm" value="'+esc(q.option_c)+'" onchange="updateQ(\''+q.id+'\',\'option_c\',this.value)" placeholder="Ø¬"><input class="inp text-sm" value="'+esc(q.option_d)+'" onchange="updateQ(\''+q.id+'\',\'option_d\',this.value)" placeholder="Ø¯"></div><div class="flex items-center gap-2"><span class="text-purple-300 text-xs">Ø§Ù„ØµØ­ÙŠØ­Ø©:</span><select class="inp" style="width:auto" onchange="updateQ(\''+q.id+'\',\'correct_option\',parseInt(this.value))"><option value="0"'+(q.correct_option===0?' selected':'')+'>Ø£</option><option value="1"'+(q.correct_option===1?' selected':'')+'>Ø¨</option><option value="2"'+(q.correct_option===2?' selected':'')+'>Ø¬</option><option value="3"'+(q.correct_option===3?' selected':'')+'>Ø¯</option></select></div></div>'}).join('')}
function esc(s){return s?s.replace(/"/g,'&quot;').replace(/'/g,'&#39;'):''}
async function addQuestion(){var r=await sb.from('quiz_questions').insert({game_id:curGameId,question_text:'',option_a:'',option_b:'',option_c:'',option_d:'',correct_option:0,sort_order:gameQuestions.length}).select().single();if(!r.error){gameQuestions.push(r.data);renderQuestions()}}
async function deleteQuestion(qid){await sb.from('quiz_questions').delete().eq('id',qid);gameQuestions=gameQuestions.filter(function(q){return q.id!==qid});renderQuestions()}
async function updateQ(qid,field,val){var upd={};upd[field]=val;await sb.from('quiz_questions').update(upd).eq('id',qid);var q=gameQuestions.find(function(x){return x.id===qid});if(q)q[field]=val}
async function saveGameSettings(){var upd={title:document.getElementById('ge-title').value,points_per_question:parseInt(document.getElementById('ge-points').value)||10,time_per_question:parseInt(document.getElementById('ge-time').value)||20,status:document.getElementById('ge-status').value};var f=document.getElementById('ge-from').value;var t=document.getElementById('ge-to').value;if(f)upd.active_from=new Date(f).toISOString();if(t)upd.active_to=new Date(t).toISOString();
  await sb.from('quiz_games').update(upd).eq('id',curGameId);curGameData=Object.assign(curGameData,upd);floatTxt('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸!','#34d399')}

// === HOST ===
async function startHosting(){if(!curGameId)return;if(gameQuestions.length===0){floatTxt('âŒ Ø£Ø¶Ù Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹','#f87171');return}
  await saveGameSettings();GC=curGameData.game_code;GAMETIME=curGameData.time_per_question;GAMEPOINTS=curGameData.points_per_question;isHost=true;
  scr('scr-host-lobby');document.getElementById('h-code').textContent=GC;document.getElementById('hl-title').textContent='ğŸ‘¨â€ğŸ« '+curGameData.title;document.getElementById('hl-info').textContent=gameQuestions.length+' Ø³Ø¤Ø§Ù„ â€¢ '+GAMEPOINTS+' Ù†Ù‚Ø·Ø© â€¢ '+GAMETIME+'Ø«';
  var qe=document.getElementById('qr-box');qe.innerHTML='';new QRCode(qe,{text:location.origin+location.pathname+'?join='+GC,width:160,height:160,colorDark:'#1a0a2e',colorLight:'#fff',correctLevel:QRCode.CorrectLevel.H});
  await sb.from('quiz_players').insert({game_code:GC,player_name:'Ù…Ø¶ÙŠÙ',is_host:true,score:0,correct_count:0,total_time:0,status:'lobby',powerups:{},current_answer:-1,answer_time:0,game_id:curGameId});
  hostRefresh();hostPollLobby=setInterval(hostRefresh,1500)}
async function hostRefresh(){var r=await sb.from('quiz_players').select('*').eq('game_code',GC).eq('is_host',false).order('created_at',{ascending:true});var l=r.data||[];totalPlayers=l.length;var c=document.getElementById('h-players'),b=document.getElementById('h-count');if(!c)return;if(!l.length)c.innerHTML='<p class="text-purple-400 text-sm text-center py-4 awp">â³</p>';else c.innerHTML=l.map(function(p,i){return '<div class="flex items-center justify-between p-3 rounded-xl bg-white/5 are" style="animation-delay:'+i*40+'ms"><div class="flex items-center gap-3"><span class="w-7 h-7 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-white text-xs font-bold">'+(i+1)+'</span><span class="text-white font-semibold text-sm">'+p.player_name+'</span></div><span class="sd"></span></div>'}).join('');if(b)b.textContent=l.length;var btn=document.getElementById('h-start-btn');if(btn)btn.disabled=!l.length}
async function hostSendStart(){if(hostPollLobby){clearInterval(hostPollLobby);hostPollLobby=null}qi=0;await sb.from('quiz_players').update({score:0,correct_count:0,total_time:0,current_answer:-1,answer_time:0,status:'playing'}).eq('game_code',GC).eq('is_host',false);await sb.from('quiz_players').update({status:'q_0'}).eq('game_code',GC).eq('is_host',true);scr('scr-host-game');hostShowQ()}
function hostShowQ(){if(qi>=gameQuestions.length){hostEnd();return}var q=gameQuestions[qi];var opts=[q.option_a,q.option_b,q.option_c,q.option_d];answeredCount=0;hostTimerDone=false;document.getElementById('hg-qnum').textContent=(qi+1)+'/'+gameQuestions.length;document.getElementById('hg-pts').textContent=GAMEPOINTS;document.getElementById('hg-qtxt').textContent=q.question_text;document.getElementById('hg-prog').style.width=((qi+1)/gameQuestions.length*100)+'%';document.getElementById('hg-ans-count').textContent='0/'+totalPlayers;document.getElementById('hg-ans-bar').style.width='0%';document.getElementById('hg-next-btn').classList.add('hidden');document.getElementById('hg-show-btn').classList.add('hidden');document.getElementById('hg-opts').innerHTML=opts.map(function(op,i){return '<div class="p-4 rounded-2xl bg-gradient-to-br '+OC[i]+' text-white font-bold text-lg shadow-lg opacity-80 asu" style="animation-delay:'+i*60+'ms">'+op+'</div>'}).join('');tl=GAMETIME;hostStartTm();if(hostPollAnswers)clearInterval(hostPollAnswers);hostPollAnswers=setInterval(hostCheckAns,1000)}
function hostStartTm(){updHT();tmr=setInterval(function(){tl--;updHT();if(tl<=0){clearInterval(tmr);tmr=null;hostTimeUp()}},1000)}
function updHT(){var n=document.getElementById('hg-timer'),b=document.getElementById('hg-timer-box');n.textContent=tl;if(tl<=5){b.classList.add('atp');n.classList.add('text-red-200');n.classList.remove('text-white')}else{b.classList.remove('atp');n.classList.remove('text-red-200');n.classList.add('text-white')}}
async function hostCheckAns(){try{var r=await sb.from('quiz_players').select('current_answer').eq('game_code',GC).eq('is_host',false);var d=r.data||[];totalPlayers=d.length;answeredCount=d.filter(function(p){return p.current_answer!==-1}).length;document.getElementById('hg-ans-count').textContent=answeredCount+'/'+totalPlayers;document.getElementById('hg-ans-bar').style.width=totalPlayers?(answeredCount/totalPlayers*100)+'%':'0%';if(answeredCount>=totalPlayers&&totalPlayers>0&&!hostTimerDone){if(tmr){clearInterval(tmr);tmr=null}hostTimeUp()}}catch(e){}}
async function hostTimeUp(){if(hostTimerDone)return;hostTimerDone=true;if(hostPollAnswers){clearInterval(hostPollAnswers);hostPollAnswers=null}var q=gameQuestions[qi];var opts=[q.option_a,q.option_b,q.option_c,q.option_d];document.getElementById('hg-opts').innerHTML=opts.map(function(op,i){return '<div class="p-4 rounded-2xl bg-gradient-to-br '+(i===q.correct_option?'from-emerald-400 to-green-500 ring-4 ring-white ace':'from-gray-600 to-gray-700 opacity-50')+' text-white font-bold text-lg shadow-lg asu" style="animation-delay:'+i*60+'ms">'+(i===q.correct_option?'âœ… ':'')+op+'</div>'}).join('');document.getElementById('hg-next-btn').classList.remove('hidden');document.getElementById('hg-show-btn').classList.remove('hidden');await hostCheckAns();await sb.from('quiz_players').update({status:'timeup_'+qi}).eq('game_code',GC).eq('is_host',true)}
async function hostShowLB(){var r=await sb.from('quiz_players').select('*').eq('game_code',GC).eq('is_host',false);var s=sortPlayers(r.data||[]);scr('scr-host-mid');document.getElementById('hm-info').textContent='Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ø¤Ø§Ù„ '+(qi+1)+' Ù…Ù† '+gameQuestions.length;var md=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];document.getElementById('hm-ranks').innerHTML=s.map(function(p,i){return '<div class="flex items-center justify-between p-4 rounded-xl '+(i===0?'bg-gradient-to-r from-yellow-500/20 to-amber-500/20 ring-1 ring-yellow-500/30':'bg-white/5')+' are" style="animation-delay:'+i*60+'ms"><div class="flex items-center gap-3"><span class="text-2xl w-8 text-center">'+(md[i]||(i+1))+'</span><div><span class="text-white font-bold">'+p.player_name+'</span><div class="flex gap-3 mt-1"><span class="text-emerald-400 text-xs">'+p.score+' Ù†Ù‚Ø·Ø©</span><span class="text-cyan-400 text-xs">â±'+p.total_time.toFixed(1)+'Ø«</span></div></div></div><span class="text-xl font-black '+(i===0?'text-yellow-400':'text-white')+'">'+p.score+'</span></div>'}).join('')}
async function hostNextQ(){qi++;if(qi>=gameQuestions.length){hostEnd();return}await sb.from('quiz_players').update({current_answer:-1,answer_time:0}).eq('game_code',GC).eq('is_host',false);await sb.from('quiz_players').update({status:'q_'+qi}).eq('game_code',GC).eq('is_host',true);answeredCount=0;scr('scr-host-game');hostShowQ()}
async function hostEnd(){clearAll();await sb.from('quiz_players').update({status:'finished'}).eq('game_code',GC).eq('is_host',true);showFinal()}
function sortPlayers(data){return data.sort(function(a,b){if(b.score!==a.score)return b.score-a.score;return a.total_time-b.total_time})}

// === PLAYER ===
async function joinGame(){var n=document.getElementById('inp-name').value.trim(),co=document.getElementById('inp-code').value.trim(),m=document.getElementById('join-msg');if(!n){m.className='text-sm mt-3 min-h-[20px] text-center text-red-400';m.textContent='âŒ Ø§Ø³Ù…Ùƒ';return}if(co.length!==4){m.className='text-sm mt-3 min-h-[20px] text-center text-red-400';m.textContent='âŒ 4 Ø£Ø±Ù‚Ø§Ù…';return}m.className='text-sm mt-3 min-h-[20px] text-center text-purple-300';m.textContent='â³...';
  var hr=await sb.from('quiz_players').select('id,game_id').eq('game_code',co).eq('is_host',true).limit(1);if(!hr.data||!hr.data.length){m.className='text-sm mt-3 min-h-[20px] text-center text-red-400';m.textContent='âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„Ø¹Ø¨Ø©';return}
  var gid=hr.data[0].game_id;
  // Load game settings
  if(gid){var gr=await sb.from('quiz_games').select('*').eq('id',gid).single();if(gr.data){GAMETIME=gr.data.time_per_question;GAMEPOINTS=gr.data.points_per_question;
    // Check date range
    var now=new Date();if(gr.data.active_from&&new Date(gr.data.active_from)>now){m.className='text-sm mt-3 min-h-[20px] text-center text-red-400';m.textContent='âŒ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù… ØªØ¨Ø¯Ø£ Ø¨Ø¹Ø¯';return}
    if(gr.data.active_to&&new Date(gr.data.active_to)<now){m.className='text-sm mt-3 min-h-[20px] text-center text-red-400';m.textContent='âŒ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù†ØªÙ‡Øª';return}}
    // Load questions
    var qr=await sb.from('quiz_questions').select('*').eq('game_id',gid).order('sort_order',{ascending:true});gameQuestions=qr.data||[]}
  var ir=await sb.from('quiz_players').insert({game_code:co,player_name:n,is_host:false,score:0,correct_count:0,total_time:0,status:'joined',powerups:{extend:false,auto:false,eliminate:false},current_answer:-1,answer_time:0,game_id:gid}).select().single();
  if(ir.error){m.className='text-sm mt-3 min-h-[20px] text-center text-red-400';m.textContent='âŒ '+ir.error.message;return}
  myName=n;myId=ir.data.id;GC=co;myScore=0;myCC=0;myTT=0;myPW={extend:false,auto:false,eliminate:false};scr('scr-wait');document.getElementById('w-name').textContent='Ù…Ø±Ø­Ø¨Ø§Ù‹ '+n+' ğŸ‘‹';playerPollState=setInterval(playerCheck,1500)}
var lastHSt='';
async function playerCheck(){try{var r=await sb.from('quiz_players').select('status').eq('game_code',GC).eq('is_host',true).limit(1);if(!r.data||!r.data.length)return;var st=r.data[0].status;if(st===lastHSt)return;lastHSt=st;if(st.indexOf('q_')===0){qi=parseInt(st.split('_')[1]);pAns=false;if(tmr){clearInterval(tmr);tmr=null}initAudio();scr('scr-player-q');playerShowQ()}else if(st.indexOf('timeup_')===0){if(tmr){clearInterval(tmr);tmr=null}if(!pAns)playerTimeout();setTimeout(function(){scr('scr-player-wait-next');document.getElementById('pwn-score').textContent=myScore;document.getElementById('pwn-correct').textContent=myCC},2200)}else if(st==='finished'){clearAll();showFinal()}}catch(e){}}
function playerShowQ(){if(qi>=gameQuestions.length)return;var q=gameQuestions[qi];var opts=[q.option_a,q.option_b,q.option_c,q.option_d];pAns=false;document.getElementById('pq-num').textContent=(qi+1)+'/'+gameQuestions.length;document.getElementById('pq-score').textContent=myScore+' Ù†Ù‚Ø·Ø©';document.getElementById('pq-txt').textContent=q.question_text;document.getElementById('pq-prog').style.width=((qi+1)/gameQuestions.length*100)+'%';updPW();var h='';for(var i=0;i<opts.length;i++){h+='<button id="opt-'+i+'" onclick="playerAns('+i+')" class="ob p-5 rounded-2xl bg-gradient-to-br '+OC[i]+' text-white font-bold text-lg md:text-xl shadow-lg asu" style="animation-delay:'+i*60+'ms">'+opts[i]+'</button>'}document.getElementById('pq-opts').innerHTML=h;tl=GAMETIME;playerStartTm()}
function playerStartTm(){updPT();tmr=setInterval(function(){tl--;updPT();if(tl<=10&&tl>0)playTk();if(tl<=0){clearInterval(tmr);tmr=null;if(!pAns)playerTimeout()}},1000)}
function updPT(){var n=document.getElementById('pq-timer'),b=document.getElementById('pq-timer-box');n.textContent=tl;if(tl<=5){b.classList.add('atp');n.classList.add('text-red-200');n.classList.remove('text-white')}else{b.classList.remove('atp');n.classList.remove('text-red-200');n.classList.add('text-white')}}
function updPW(){['extend','auto','eliminate'].forEach(function(t){var b=document.getElementById('pw-'+t);if(myPW[t]){b.classList.add('used');b.disabled=true}else{b.classList.remove('used');b.disabled=false}})}
function usePW(t){if(pAns||myPW[t])return;myPW[t]=true;document.getElementById('pw-'+t).classList.add('used');document.getElementById('pw-'+t).disabled=true;playPU();
  if(t==='extend'){tl+=10;updPT();floatTxt('â±ï¸ +10Ø«!','#22d3ee');sb.from('quiz_players').update({powerups:myPW}).eq('id',myId)}
  else if(t==='auto'){if(tmr){clearInterval(tmr);tmr=null}var q=gameQuestions[qi];pAns=true;var tt=GAMETIME-tl;myScore+=GAMEPOINTS;myCC++;myTT+=tt;for(var i=0;i<4;i++){var btn=document.getElementById('opt-'+i);if(btn){btn.disabled=true;if(i===q.correct_option)btn.className='ob p-5 rounded-2xl bg-gradient-to-br from-emerald-400 to-green-500 text-white font-bold text-lg md:text-xl shadow-lg ring-4 ring-white ace'}}playOK();showPRes(true,GAMEPOINTS);floatTxt('âœ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ©!','#a3e635');sendAns(q.correct_option,tt)}
  else if(t==='eliminate'){var q=gameQuestions[qi];var w=[];for(var i=0;i<4;i++){if(i!==q.correct_option)w.push(i)}for(var j=w.length-1;j>0;j--){var k=Math.floor(Math.random()*(j+1));var tmp=w[j];w[j]=w[k];w[k]=tmp}for(var x=0;x<2;x++){var btn=document.getElementById('opt-'+w[x]);if(btn){btn.classList.add('opt-hidden');btn.disabled=true}}floatTxt('ğŸš« 50/50!','#f472b6');sb.from('quiz_players').update({powerups:myPW}).eq('id',myId)}}
function playerAns(idx){if(pAns)return;pAns=true;if(tmr){clearInterval(tmr);tmr=null}var q=gameQuestions[qi],ok=(idx===q.correct_option),tt=GAMETIME-tl;for(var i=0;i<4;i++){var btn=document.getElementById('opt-'+i);if(btn){btn.disabled=true;if(i===q.correct_option)btn.className='ob p-5 rounded-2xl bg-gradient-to-br from-emerald-400 to-green-500 text-white font-bold text-lg md:text-xl shadow-lg ring-4 ring-white ace';else if(i===idx&&!ok)btn.className='ob p-5 rounded-2xl bg-gradient-to-br from-red-500 to-red-700 text-white font-bold text-lg md:text-xl shadow-lg ash'}}if(ok){myScore+=GAMEPOINTS;myCC++;myTT+=tt;playOK()}else{playNG()}showPRes(ok,ok?GAMEPOINTS:0);sendAns(idx,tt)}
function playerTimeout(){if(pAns)return;pAns=true;var q=gameQuestions[qi];for(var i=0;i<4;i++){var btn=document.getElementById('opt-'+i);if(btn){btn.disabled=true;if(i===q.correct_option)btn.classList.add('ring-4','ring-white')}}playNG();showPRes(false,0,true);sendAns(-2,GAMETIME)}
async function sendAns(idx,tt){var ud={current_answer:idx,answer_time:tt,score:myScore,correct_count:myCC,total_time:myTT,powerups:myPW};for(var a=0;a<3;a++){try{var r=await sb.from('quiz_players').update(ud).eq('id',myId).select();if(!r.error)return}catch(e){}await new Promise(function(r){setTimeout(r,500)})}}
function showPRes(ok,pt,to){var ov=document.getElementById('pq-result'),cd=document.getElementById('pq-res-card');document.getElementById('pq-res-emoji').textContent=to?'â°':(ok?'ğŸ‰':'ğŸ˜¢');document.getElementById('pq-res-txt').textContent=to?'Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!':(ok?'ØµØ­ÙŠØ­Ø©!':'Ø®Ø§Ø·Ø¦Ø©!');document.getElementById('pq-res-pts').textContent=ok?'+'+pt+' Ù†Ù‚Ø·Ø©':'';ov.classList.remove('hidden');requestAnimationFrame(function(){cd.style.transform='scale(1)'});if(ok)confetti(8);setTimeout(function(){cd.style.transform='scale(0)';setTimeout(function(){ov.classList.add('hidden')},300)},2000)}

async function showFinal(){clearAll();var r=await sb.from('quiz_players').select('*').eq('game_code',GC).eq('is_host',false);var s=sortPlayers(r.data||[]);scr('scr-final');confetti(40);var po=document.getElementById('fin-podium'),md=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];if(s.length>=3){var ord=[s[1],s[0],s[2]],h=['h-24','h-36','h-20'],me=['ğŸ¥ˆ','ğŸ¥‡','ğŸ¥‰'],bg=['from-gray-300/20 to-gray-400/20','from-yellow-300/20 to-amber-400/20','from-orange-400/20 to-orange-500/20'];po.innerHTML=ord.map(function(p,i){return '<div class="flex flex-col items-center asu" style="animation-delay:'+i*200+'ms"><span class="text-5xl mb-2">'+me[i]+'</span><p class="text-white font-bold text-sm truncate max-w-[80px]">'+p.player_name+'</p><p class="text-yellow-300 font-black text-xl">'+p.score+'</p><div class="'+h[i]+' w-24 rounded-t-xl bg-gradient-to-t '+bg[i]+' mt-2 flex items-end justify-center pb-2"><span class="text-white/60 text-xs">â±'+p.total_time.toFixed(1)+'Ø«</span></div></div>'}).join('')}else po.innerHTML=s.map(function(p,i){return '<div class="flex flex-col items-center asu"><span class="text-5xl mb-2">'+(md[i]||'')+'</span><p class="text-white font-bold">'+p.player_name+'</p><p class="text-yellow-300 font-black text-2xl">'+p.score+'</p></div>'}).join('');
  document.getElementById('fin-ranks').innerHTML=s.map(function(p,i){return '<div class="flex items-center justify-between p-4 rounded-xl '+(i===0?'bg-gradient-to-r from-yellow-500/20 to-amber-500/20 ring-1 ring-yellow-500/30':'bg-white/5')+' are" style="animation-delay:'+(i+3)*80+'ms"><div class="flex items-center gap-3"><span class="text-2xl w-8 text-center">'+(md[i]||(i+1))+'</span><div><p class="text-white font-bold">'+p.player_name+'</p><div class="flex gap-3 mt-1"><span class="text-emerald-400 text-xs">'+p.score+' Ù†Ù‚Ø·Ø©</span><span class="text-cyan-400 text-xs">â±'+p.total_time.toFixed(1)+'Ø«</span><span class="text-amber-400 text-xs">âœ“'+p.correct_count+'</span></div></div></div><p class="text-2xl font-black '+(i===0?'text-yellow-400':'text-white')+'">'+p.score+'</p></div>'}).join('')}

// === QR/AUDIO/HELPERS ===
var qrs=null,qri=null;
function openQR(){var v=document.getElementById('qr-video'),o=document.getElementById('qr-overlay');v.classList.remove('hidden');o.classList.remove('hidden');navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(function(s){qrs=s;v.srcObject=s;v.play();doScan(v)}).catch(function(){closeQR()})}
function doScan(v){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';s.onload=function(){var cv=document.createElement('canvas'),cx=cv.getContext('2d');qri=setInterval(function(){if(v.readyState===v.HAVE_ENOUGH_DATA){cv.width=v.videoWidth;cv.height=v.videoHeight;cx.drawImage(v,0,0);var d=cx.getImageData(0,0,cv.width,cv.height),r=window.jsQR(d.data,cv.width,cv.height);if(r){closeQR();try{var u=new URL(r.data),jc=u.searchParams.get('join');if(jc){document.getElementById('inp-code').value=jc;if(document.getElementById('inp-name').value.trim())joinGame();else document.getElementById('inp-name').focus()}}catch(e){}}}},150)};document.head.appendChild(s)}
function closeQR(){if(qri){clearInterval(qri);qri=null}if(qrs){qrs.getTracks().forEach(function(t){t.stop()});qrs=null}document.getElementById('qr-video').classList.add('hidden');document.getElementById('qr-overlay').classList.add('hidden')}
function initAudio(){if(!ac)ac=new(window.AudioContext||window.webkitAudioContext)()}
function tone(f,d,t,v){if(!ac)return;t=t||'sine';v=v||.2;try{var o=ac.createOscillator(),g=ac.createGain();o.connect(g);g.connect(ac.destination);o.frequency.value=f;o.type=t;g.gain.setValueAtTime(v,ac.currentTime);g.gain.exponentialRampToValueAtTime(.001,ac.currentTime+d);o.start();o.stop(ac.currentTime+d)}catch(e){}}
function playTk(){tone(tl<=5?880:440,.08)}function playOK(){tone(523,.12);setTimeout(function(){tone(659,.12)},70);setTimeout(function(){tone(784,.18)},140)}function playNG(){tone(200,.25,'sawtooth',.12)}function playPU(){tone(880,.08);setTimeout(function(){tone(1100,.1)},50);setTimeout(function(){tone(1320,.15)},100)}
function floatTxt(t,c){var d=document.createElement('div');d.className='asu';d.style.cssText='position:fixed;top:35%;left:50%;transform:translateX(-50%);z-index:300;font-size:1.6rem;font-weight:900;color:'+(c||'#fff')+';text-shadow:0 4px 20px rgba(0,0,0,.6);pointer-events:none';d.textContent=t;document.body.appendChild(d);setTimeout(function(){d.remove()},1500)}
function confetti(n){var ct=document.getElementById('confetti-box'),cl=['#f472b6','#22d3ee','#a3e635','#fbbf24','#d946ef','#f97316','#34d399'];for(var i=0;i<n;i++){var p=document.createElement('div');p.className='cf';p.style.cssText='left:'+Math.random()*100+'%;background:'+cl[Math.floor(Math.random()*cl.length)]+';animation-delay:'+Math.random()*2+'s;animation-duration:'+(2+Math.random()*2)+'s;width:'+(6+Math.random()*8)+'px;height:'+(6+Math.random()*8)+'px;border-radius:'+(Math.random()>.5?'50%':'2px');ct.appendChild(p);setTimeout(function(el){el.remove()},5000,p)}}
async function goHome(){clearAll();try{if(GC){if(isHost)await sb.from('quiz_players').delete().eq('game_code',GC);else if(myId)await sb.from('quiz_players').delete().eq('id',myId)}}catch(e){}GC='';isHost=false;myName='';myId=null;myScore=0;myCC=0;myTT=0;qi=0;pAns=false;lastHSt='';myPW={extend:false,auto:false,eliminate:false};var u=new URL(location.href);u.searchParams.delete('join');history.replaceState({},'',u);scr('scr-role')}
</script></body></html>
