<!DOCTYPE html>
<html lang="ar" dir="rtl" class="h-full">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ø®ØªØ¨Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>
<script src="https://cdn.tailwindcss.com/3.4.17"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*{font-family:'Noto Kufi Arabic',sans-serif;box-sizing:border-box}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:3px}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
@keyframes sup{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes sdn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
@keyframes sci{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}
@keyframes shk{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
@keyframes cel{0%,100%{transform:scale(1)}50%{transform:scale(1.12) rotate(3deg)}}
@keyframes cff{0%{transform:translateY(-100vh) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
@keyframes tpls{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
@keyframes ren{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
@keyframes wpl{0%,100%{opacity:.5}50%{opacity:1}}
.af{animation:float 3s ease-in-out infinite}.asu{animation:sup .5s ease-out both}.asd{animation:sdn .4s ease-out both}
.asi{animation:sci .35s ease-out both}.ash{animation:shk .4s ease}.ace{animation:cel .5s ease}
.atp{animation:tpls .5s ease-in-out infinite}.are{animation:ren .4s ease-out both}
.awp{animation:wpl 1.5s ease-in-out infinite}
.cg{background:linear-gradient(135deg,rgba(255,255,255,.08),rgba(255,255,255,.02));backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,.12)}
.ob{transition:all .2s ease;position:relative;overflow:hidden}
.ob:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 30px -8px rgba(0,0,0,.4)}
.pt{transition:width .4s ease-out}
.cf{position:fixed;width:10px;height:10px;top:-20px;z-index:100;animation:cff 3s linear forwards}
.qb{background:#fff;padding:14px;border-radius:14px;display:inline-block}
.pc{transition:all .3s ease;cursor:pointer}.pc:hover:not(.used){transform:translateY(-3px)}
.pc.used{opacity:.3;cursor:not-allowed;filter:grayscale(1);pointer-events:none}
.bm{background:radial-gradient(ellipse at 20% 50%,rgba(120,0,255,.25) 0%,transparent 50%),radial-gradient(ellipse at 80% 20%,rgba(255,0,150,.2) 0%,transparent 50%),radial-gradient(ellipse at 50% 80%,rgba(0,200,255,.15) 0%,transparent 50%),linear-gradient(160deg,#0f0326,#1a0a2e 30%,#16082a 60%,#0d0420)}
.sd{width:8px;height:8px;border-radius:50%;display:inline-block;background:#34d399;box-shadow:0 0 6px #34d399}
.opt-hidden{opacity:.12!important;pointer-events:none!important;transform:scale(.95)!important}
.inp{width:100%;padding:10px 14px;border-radius:12px;background:rgba(255,255,255,.08);color:#fff;border:1px solid rgba(255,255,255,.15);outline:none;font-size:.95rem}
.inp:focus{border-color:#a855f7}.inp::placeholder{color:rgba(255,255,255,.3)}
.btn-p{padding:10px 24px;border-radius:12px;background:linear-gradient(135deg,#a855f7,#ec4899);color:#fff;font-weight:700;border:none;cursor:pointer;transition:all .2s}
.btn-p:hover{transform:scale(1.03)}.btn-p:disabled{opacity:.4;cursor:not-allowed;transform:none}
.btn-s{padding:8px 20px;border-radius:10px;background:rgba(255,255,255,.08);color:#d8b4fe;border:1px solid rgba(255,255,255,.12);cursor:pointer;transition:all .2s}
.btn-s:hover{background:rgba(255,255,255,.15)}
.btn-d{padding:6px 14px;border-radius:8px;background:rgba(239,68,68,.2);color:#fca5a5;border:none;cursor:pointer;font-size:.8rem}
.badge{display:inline-block;padding:2px 10px;border-radius:20px;font-size:.75rem;font-weight:600}
.tab-btn{padding:8px 20px;border-radius:10px;cursor:pointer;transition:all .2s;font-weight:600;font-size:.9rem}
.tab-btn.active{background:linear-gradient(135deg,#a855f7,#ec4899);color:#fff}
.tab-btn:not(.active){background:rgba(255,255,255,.06);color:#d8b4fe}
.stat-card{text-align:center;padding:20px 16px;border-radius:16px}
.stat-num{font-size:2rem;font-weight:900;margin-bottom:2px}
.stat-lbl{font-size:.78rem;opacity:.7}
.tbl{width:100%;border-collapse:separate;border-spacing:0}
.tbl th{padding:10px;text-align:right;font-size:.75rem;color:#d8b4fe;border-bottom:1px solid rgba(255,255,255,.1);font-weight:600}
.tbl td{padding:8px 10px;font-size:.8rem;color:#e2e8f0;border-bottom:1px solid rgba(255,255,255,.05)}
.tbl tr:hover td{background:rgba(255,255,255,.03)}
.ai-box{background:linear-gradient(135deg,rgba(168,85,247,.12),rgba(236,72,153,.08));border:1px solid rgba(168,85,247,.25);border-radius:16px;padding:24px}
.ai-box h4{color:#e9d5ff;font-weight:800;margin-bottom:14px;font-size:1.05rem}
.ai-txt{color:#d8b4fe;font-size:.88rem;line-height:2}
.bar-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.bar-label{width:40px;text-align:center;color:#d8b4fe;font-size:.75rem;font-weight:600;flex-shrink:0}
.bar-bg{flex:1;height:24px;background:rgba(255,255,255,.06);border-radius:8px;overflow:hidden;position:relative}
.bar-fill{height:100%;border-radius:8px;transition:width .6s ease;display:flex;align-items:center;padding-right:8px;justify-content:flex-end}
.bar-fill span{font-size:.7rem;font-weight:700;color:#fff}
</style>
</head>
<body class="h-full overflow-auto bm">
<div id="scr-loading" class="min-h-full flex flex-col items-center justify-center p-6"><div class="text-center asi"><div class="text-8xl mb-6 af">ğŸ¤–</div><h1 class="text-3xl font-black text-white mb-4">Ø§Ø®ØªØ¨Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h1><p class="text-purple-300 mt-4" id="load-txt">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</p></div></div>

<div id="scr-role" class="hidden min-h-full flex flex-col items-center justify-center p-6"><div class="text-center max-w-2xl w-full"><div class="text-9xl mb-4 af">ğŸ¤–</div><h1 class="text-4xl md:text-5xl font-black text-white mb-2 asu">Ø§Ø®ØªØ¨Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h1><p class="text-lg text-purple-300 mb-10 asu" style="animation-delay:.1s">Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù„Ù…ÙŠ â€¢ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ± â€¢ Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</p><div class="grid grid-cols-1 md:grid-cols-3 gap-5"><div onclick="scr('scr-admin-login')" class="cg rounded-3xl p-7 cursor-pointer hover:scale-105 transition-all asu" style="animation-delay:.15s"><div class="text-6xl mb-3">ğŸ‘¨â€ğŸ«</div><h2 class="text-xl font-bold text-white mb-1">Ø§Ù„Ù…Ù†Ø¸Ù…</h2><p class="text-purple-300 text-sm">Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ­ÙƒÙ…</p></div><div onclick="pickRole('player')" class="cg rounded-3xl p-7 cursor-pointer hover:scale-105 transition-all asu" style="animation-delay:.25s"><div class="text-6xl mb-3">ğŸ®</div><h2 class="text-xl font-bold text-white mb-1">Ù„Ø§Ø¹Ø¨</h2><p class="text-purple-300 text-sm">Ø§Ù†Ø¶Ù… ÙˆØ£Ø¬Ø¨</p></div><div onclick="scr('scr-instructions')" class="cg rounded-3xl p-7 cursor-pointer hover:scale-105 transition-all asu" style="animation-delay:.35s"><div class="text-6xl mb-3">ğŸ“–</div><h2 class="text-xl font-bold text-white mb-1">Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</h2><p class="text-purple-300 text-sm">ÙƒÙŠÙ ØªÙ„Ø¹Ø¨ØŸ</p></div></div></div></div>

<div id="scr-instructions" class="hidden min-h-full flex flex-col items-center p-6 pt-8"><div class="max-w-2xl w-full"><div class="text-center mb-6"><div class="text-7xl mb-3">ğŸ“–</div><h2 class="text-3xl font-black text-white">Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</h2></div><div class="cg rounded-2xl p-6 mb-4 asu"><p class="text-purple-300 text-sm mb-1">ğŸ‘¨â€ğŸ« <b class="text-white">Ø§Ù„Ù…Ù†Ø¸Ù…</b>: ÙŠÙ†Ø´Ø¦ Ø­Ø³Ø§Ø¨ ÙˆÙŠØ¶Ø¨Ø· Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ø²Ù…Ù†</p><p class="text-purple-300 text-sm">ğŸ® <b class="text-white">Ø§Ù„Ù„Ø§Ø¹Ø¨</b>: ÙŠÙ†Ø¶Ù… Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ QR</p></div><div class="cg rounded-2xl p-6 mb-4 asu"><p class="text-purple-300 text-sm mb-1">â±ï¸ +10Ø« â€¢ âœ¨ Ø¥Ø¬Ø§Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© â€¢ ğŸš« 50/50</p><p class="text-purple-300 text-sm">Ø§Ù„Ù†Ù‚Ø§Ø· Ø«Ø§Ø¨ØªØ© ÙˆÙ…ØªØ³Ø§ÙˆÙŠØ© Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„ â€¢ ØªØ±Ø§ÙƒÙ…ÙŠØ©</p></div><div class="cg rounded-2xl p-6 mb-8 asu"><p class="text-purple-300 text-sm">ğŸ† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· â†’ Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø§ÙˆÙŠ Ø§Ù„Ø£Ø³Ø±Ø¹ Ø²Ù…Ù†Ø§Ù‹</p></div><div class="text-center"><button onclick="scr('scr-role')" class="btn-p text-lg px-12 py-3">ğŸ‘ ÙÙ‡Ù…Øª!</button></div></div></div>

<div id="scr-admin-login" class="hidden min-h-full flex flex-col items-center justify-center p-6"><div class="max-w-md w-full"><div class="text-center mb-6"><div class="text-6xl mb-2">ğŸ”</div><h2 class="text-3xl font-bold text-white">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¸Ù…</h2></div><div class="cg rounded-3xl p-8 asi"><div class="flex gap-2 mb-6 justify-center"><button id="tab-login" onclick="setAuthTab('login')" class="tab-btn active">Ø¯Ø®ÙˆÙ„</button><button id="tab-reg" onclick="setAuthTab('register')" class="tab-btn">Ø¬Ø¯ÙŠØ¯</button></div><div id="auth-reg-fields" class="hidden mb-4"><label class="text-white text-sm block mb-1">Ø§Ù„Ø§Ø³Ù…</label><input id="a-dname" type="text" class="inp mb-3" placeholder="Ø§Ø³Ù…Ùƒ"></div><div class="mb-4"><label class="text-white text-sm block mb-1">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input id="a-user" type="text" class="inp" placeholder="admin"></div><div class="mb-5"><label class="text-white text-sm block mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="a-pass" type="password" class="inp" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div><button onclick="doAuth()" class="btn-p w-full py-3 text-lg" id="auth-btn">Ø¯Ø®ÙˆÙ„</button><p id="auth-msg" class="text-sm mt-3 min-h-[20px] text-center"></p></div><div class="text-center mt-4"><button onclick="scr('scr-role')" class="btn-s">â† Ø±Ø¬ÙˆØ¹</button></div></div></div>

<div id="scr-dashboard" class="hidden min-h-full flex flex-col p-4 md:p-6"><div class="max-w-4xl mx-auto w-full"><div class="flex items-center justify-between mb-6 flex-wrap gap-3"><div><h2 class="text-2xl font-bold text-white">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2><p id="dash-welcome" class="text-purple-300 text-sm"></p></div><button onclick="adminLogout()" class="btn-s text-xs">ğŸšª Ø®Ø±ÙˆØ¬</button></div><div class="cg rounded-2xl p-6 mb-6 asu"><div class="flex items-center justify-between mb-4"><h3 class="text-white font-bold">ğŸ® Ø£Ù„Ø¹Ø§Ø¨ÙŠ</h3><button onclick="createNewGame()" class="btn-p text-sm">+ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button></div><div id="games-list" class="space-y-3"></div></div></div></div>

<div id="scr-editor" class="hidden min-h-full flex flex-col p-4 md:p-6"><div class="max-w-4xl mx-auto w-full"><div class="flex items-center justify-between mb-6 flex-wrap gap-3"><h2 class="text-2xl font-bold text-white">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2><div class="flex gap-2"><button onclick="loadDashboard()" class="btn-s text-xs">â† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</button><button onclick="saveGameSettings()" class="btn-p text-sm">ğŸ’¾ Ø­ÙØ¸</button></div></div><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6"><div class="cg rounded-2xl p-4 asu"><label class="text-white text-xs block mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="ge-title" class="inp" placeholder="Ø§Ø®ØªØ¨Ø§Ø±"></div><div class="cg rounded-2xl p-4 asu"><label class="text-white text-xs block mb-1">Ù†Ù‚Ø§Ø·/Ø³Ø¤Ø§Ù„</label><input id="ge-points" type="number" class="inp" min="1" value="10"></div><div class="cg rounded-2xl p-4 asu"><label class="text-white text-xs block mb-1">Ø²Ù…Ù†/Ø³Ø¤Ø§Ù„ (Ø«)</label><input id="ge-time" type="number" class="inp" min="5" value="20"></div><div class="cg rounded-2xl p-4 asu"><label class="text-white text-xs block mb-1">Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="ge-status" class="inp"><option value="draft">Ù…Ø³ÙˆØ¯Ø©</option><option value="active">Ù†Ø´Ø·Ø©</option><option value="ended">Ù…Ù†ØªÙ‡ÙŠØ©</option></select></div><div class="cg rounded-2xl p-4 asu"><label class="text-white text-xs block mb-1">Ù…Ù†</label><input id="ge-from" type="datetime-local" class="inp"></div><div class="cg rounded-2xl p-4 asu"><label class="text-white text-xs block mb-1">Ø¥Ù„Ù‰</label><input id="ge-to" type="datetime-local" class="inp"></div></div><div class="cg rounded-2xl p-6 mb-6 asu"><div class="flex items-center justify-between mb-4"><h3 class="text-white font-bold">ğŸ“ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© <span id="q-count-badge" class="badge bg-purple-500/30 text-purple-300">0</span></h3><div class="flex gap-2"><button onclick="openImport()" class="btn-s text-sm">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button><button onclick="addQuestion()" class="btn-p text-sm">+ Ø³Ø¤Ø§Ù„</button></div></div><div id="questions-editor" class="space-y-4"></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"><div class="cg rounded-2xl p-5 asu"><button onclick="startHosting()" class="btn-p text-lg w-full py-3">â–¶ï¸ Ø§Ø¨Ø¯Ø£ ÙƒÙ…Ø¶ÙŠÙ</button></div><div class="cg rounded-2xl p-5 asu"><button onclick="openReports()" class="btn-s text-lg w-full py-3">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„</button></div></div></div></div>

<div id="scr-reports" class="hidden min-h-full flex flex-col p-4 md:p-6"><div class="max-w-5xl mx-auto w-full"><div class="flex items-center justify-between mb-6 flex-wrap gap-3"><h2 class="text-2xl font-bold text-white">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</h2><div class="flex gap-2"><button onclick="openEditor(curGameId)" class="btn-s text-xs">â† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button><button onclick="exportCSV()" class="btn-p text-sm">ğŸ“¥ CSV</button></div></div><div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6" id="stats-cards"></div><div class="cg rounded-2xl p-6 mb-6 asu"><h3 class="text-white font-bold mb-4">ğŸ“Š Ù†Ø³Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„</h3><div id="stats-chart"></div></div><div class="ai-box mb-6 asu"><div class="flex items-center justify-between mb-3"><h4>ğŸ§  ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h4><button onclick="runAI()" class="btn-p text-sm" id="ai-btn">ğŸ” ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</button></div><div id="ai-analysis" class="ai-txt hidden"></div></div><div class="cg rounded-2xl p-6 mb-6 asu"><h3 class="text-white font-bold mb-4">ğŸ† ØªØ±ØªÙŠØ¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h3><div class="overflow-x-auto"><table class="tbl"><thead><tr><th>#</th><th>Ø§Ù„Ù„Ø§Ø¹Ø¨</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th><th>âœ“</th><th>âœ—</th><th>Ø§Ù„Ø²Ù…Ù†</th><th>%</th></tr></thead><tbody id="rpt-players"></tbody></table></div></div><div class="cg rounded-2xl p-6 mb-6 asu"><h3 class="text-white font-bold mb-4">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø§Øª</h3><div class="overflow-x-auto"><table class="tbl"><thead><tr><th>Ø§Ù„Ù„Ø§Ø¹Ø¨</th><th>Ø§Ù„Ø³Ø¤Ø§Ù„</th><th>Ø§Ø®ØªÙŠØ§Ø±Ù‡</th><th>Ø§Ù„ØµØ­ÙŠØ­Ø©</th><th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th><th>Ø§Ù„Ø²Ù…Ù†</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr></thead><tbody id="rpt-responses"></tbody></table></div></div></div></div>
<div id="scr-host-lobby" class="hidden min-h-full flex flex-col items-center p-6 pt-8"><div class="text-center max-w-3xl w-full"><h2 class="text-3xl font-bold text-white mb-2 asd" id="hl-title">ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨Ø©</h2><p id="hl-info" class="text-purple-300 text-sm mb-6"></p><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"><div class="cg rounded-2xl p-6 asu"><p class="text-purple-300 text-sm mb-2">ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</p><div id="h-code" class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-pink-400 tracking-[.3em] my-3">0000</div><button onclick="navigator.clipboard.writeText(GC)" class="btn-s text-sm">ğŸ“‹ Ù†Ø³Ø®</button></div><div class="cg rounded-2xl p-6 asu flex flex-col items-center"><p class="text-purple-300 text-sm mb-3">QR</p><div id="qr-box" class="qb"></div></div></div><div class="cg rounded-2xl p-6 mb-6 asu"><div class="flex items-center justify-between mb-4"><h3 class="text-white font-bold">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†</h3><span id="h-count" class="badge bg-purple-500/30 text-purple-300">0</span></div><div id="h-players" class="max-h-72 overflow-y-auto grid grid-cols-3 md:grid-cols-6 gap-2"><p class="text-purple-400 text-sm text-center py-4 awp col-span-full">â³</p></div></div><button id="h-start-btn" onclick="hostSendStart()" disabled class="btn-p text-xl px-14 py-4">â–¶ï¸ Ø§Ø¨Ø¯Ø£</button></div></div>

<div id="scr-host-game" class="hidden min-h-full flex flex-col p-4 md:p-6"><div class="flex flex-wrap items-center justify-between gap-3 mb-4"><div class="cg px-4 py-2 rounded-xl"><span class="text-purple-300 text-xs">Ø§Ù„Ø³Ø¤Ø§Ù„ </span><span id="hg-qnum" class="text-white font-bold"></span></div><div class="cg px-3 py-2 rounded-xl"><span class="text-amber-400 font-bold" id="hg-pts"></span></div><div class="cg rounded-xl p-1"><div id="hg-timer-box" class="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center"><span id="hg-timer" class="text-white font-black text-2xl">20</span></div></div></div><div class="w-full h-2 bg-white/10 rounded-full mb-4 overflow-hidden"><div id="hg-prog" class="pt h-full rounded-full bg-gradient-to-r from-purple-500 via-pink-500 to-amber-400" style="width:5%"></div></div><div class="flex-1 flex flex-col items-center justify-center"><div class="cg rounded-3xl p-6 md:p-10 w-full max-w-3xl mb-6 asi"><h2 id="hg-qtxt" class="text-xl md:text-3xl font-bold text-white text-center leading-relaxed"></h2></div><div id="hg-opts" class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-3xl mb-6"></div><div class="cg rounded-2xl p-4 w-full max-w-3xl"><div class="flex items-center justify-between mb-2"><span class="text-purple-300 text-sm">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</span><span id="hg-ans-count" class="text-white font-bold text-xl">0/0</span></div><div class="w-full h-3 bg-white/10 rounded-full overflow-hidden"><div id="hg-ans-bar" class="pt h-full rounded-full bg-gradient-to-r from-emerald-400 to-teal-500" style="width:0%"></div></div></div></div><div class="mt-6 text-center"><button id="hg-next-btn" onclick="hostNextQ()" class="hidden btn-p text-xl px-12 py-4">â–¶ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button><button id="hg-show-btn" onclick="hostShowLB()" class="hidden btn-s text-lg px-10 py-3 mr-3">ğŸ“Š</button></div></div>

<div id="scr-host-mid" class="hidden min-h-full flex flex-col items-center justify-center p-6"><div class="text-center max-w-2xl w-full"><h2 class="text-3xl font-bold text-white mb-2 asd">ğŸ“Š Ø§Ù„ØªØ±ØªÙŠØ¨</h2><p id="hm-info" class="text-purple-300 mb-6"></p><div id="hm-ranks" class="cg rounded-2xl p-4 mb-8 space-y-2"></div><button onclick="hostNextQ()" class="btn-p text-xl px-12 py-4">â–¶ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button></div></div>

<div id="scr-join" class="hidden min-h-full flex flex-col items-center justify-center p-6"><div class="max-w-md w-full"><div class="text-center mb-6"><div class="text-6xl mb-2">ğŸ‘¤</div><h2 class="text-3xl font-bold text-white">Ø§Ù†Ø¶Ù…</h2></div><div class="cg rounded-3xl p-8 asi"><div class="mb-4"><label class="text-white text-sm block mb-1">Ø§Ø³Ù…Ùƒ</label><input id="inp-name" type="text" maxlength="20" class="inp text-lg" placeholder="Ø§Ù„Ø§Ø³Ù…"></div><div class="mb-5"><label class="text-white text-sm block mb-1">Ø§Ù„ÙƒÙˆØ¯</label><input id="inp-code" type="text" maxlength="4" class="inp text-center text-3xl font-bold tracking-[.4em]" placeholder="0000"></div><button onclick="joinGame()" class="btn-p w-full py-3 text-lg mb-3">ğŸš€ Ø¯Ø®ÙˆÙ„</button><button onclick="openQR()" class="w-full py-3 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-500 text-white font-bold">ğŸ“± QR</button><p id="join-msg" class="text-sm mt-3 min-h-[20px] text-center"></p></div><div class="text-center mt-4"><button onclick="goHome()" class="btn-s">â† Ø±Ø¬ÙˆØ¹</button></div></div><video id="qr-video" class="hidden fixed inset-0 z-50 object-cover w-full h-full" playsinline autoplay></video><div id="qr-overlay" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/80"><div class="w-64 h-64 border-4 border-white/50 rounded-2xl mb-6"></div><button onclick="closeQR()" class="px-8 py-3 rounded-xl bg-red-500 text-white font-bold">âœ•</button></div></div>

<div id="scr-wait" class="hidden min-h-full flex flex-col items-center justify-center p-6"><div class="text-center asi"><div class="text-8xl mb-6 af">âœ…</div><h2 class="text-3xl font-bold text-white mb-3">ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…!</h2><p class="text-purple-300 awp">Ø§Ù†ØªØ¸Ø§Ø±...</p><p id="w-name" class="text-white font-bold text-xl mt-4"></p></div></div>

<div id="scr-player-q" class="hidden min-h-full flex flex-col p-4 md:p-6"><div class="flex flex-wrap items-center justify-between gap-3 mb-3"><div class="cg px-3 py-2 rounded-xl"><span id="pq-num" class="text-white font-bold text-sm"></span></div><div class="cg px-3 py-2 rounded-xl"><span id="pq-score" class="text-amber-400 font-bold text-sm">0</span></div><div class="cg rounded-xl p-1"><div id="pq-timer-box" class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center"><span id="pq-timer" class="text-white font-black text-xl">20</span></div></div></div><div class="w-full h-2 bg-white/10 rounded-full mb-3 overflow-hidden"><div id="pq-prog" class="pt h-full rounded-full bg-gradient-to-r from-purple-500 via-pink-500 to-amber-400" style="width:5%"></div></div><div id="pq-powers" class="flex justify-center gap-2 mb-3"><button onclick="usePW('extend')" id="pw-extend" class="pc cg rounded-xl px-3 py-2 text-sm text-white">â±ï¸+10</button><button onclick="usePW('auto')" id="pw-auto" class="pc cg rounded-xl px-3 py-2 text-sm text-white">âœ¨ØªÙ„Ù‚Ø§Ø¦ÙŠ</button><button onclick="usePW('eliminate')" id="pw-eliminate" class="pc cg rounded-xl px-3 py-2 text-sm text-white">ğŸš«50/50</button></div><div class="flex-1 flex flex-col items-center justify-center"><div class="cg rounded-3xl p-5 md:p-8 w-full max-w-3xl mb-5 asi"><h2 id="pq-txt" class="text-lg md:text-2xl font-bold text-white text-center leading-relaxed"></h2></div><div id="pq-opts" class="grid grid-cols-1 md:grid-cols-2 gap-3 w-full max-w-3xl"></div></div><div id="pq-result" class="hidden fixed inset-0 flex items-center justify-center bg-black/60 z-50"><div id="pq-res-card" class="cg rounded-3xl p-8 text-center transform scale-0 transition-transform duration-300"><div id="pq-res-emoji" class="text-7xl mb-2"></div><p id="pq-res-txt" class="text-xl font-bold text-white"></p><p id="pq-res-pts" class="text-purple-300 mt-1"></p></div></div></div>

<div id="scr-player-wait-next" class="hidden min-h-full flex flex-col items-center justify-center p-6"><div class="text-center asi"><div class="text-6xl mb-4 awp">â³</div><h2 class="text-2xl font-bold text-white mb-2">Ø§Ù†ØªØ¸Ø§Ø±...</h2><p class="text-purple-300">Ù†ØªÙŠØ¬ØªÙƒ: <span id="pwn-score" class="text-amber-400 font-bold text-xl">0</span></p><p class="text-purple-400 text-sm mt-1">âœ“ <span id="pwn-correct" class="text-emerald-400 font-bold">0</span></p></div></div>

<div id="scr-final" class="hidden min-h-full flex flex-col items-center justify-center p-6"><div class="text-center max-w-2xl w-full"><div class="text-9xl mb-4 af">ğŸ†</div><h2 class="text-4xl font-black text-white mb-2 asd">Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h2><div id="fin-podium" class="flex items-end justify-center gap-4 mb-8 asu"></div><div id="fin-ranks" class="cg rounded-2xl p-4 mb-8 space-y-2"></div><button onclick="goHome()" class="btn-p text-xl px-12 py-4">ğŸ”„ Ø¬Ø¯ÙŠØ¯Ø©</button></div></div>
<div id="import-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black/70 z-50 p-4"><div class="cg rounded-3xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto"><div class="flex items-center justify-between mb-4"><h3 class="text-white font-bold text-lg">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3><button onclick="closeImport()" class="text-purple-400 text-2xl font-bold">âœ•</button></div>
<div class="mb-4"><div class="flex gap-2 mb-3"><button id="imp-tab-paste" onclick="setImpTab('paste')" class="tab-btn active">ğŸ“‹ Ù†Ø³Ø® ÙˆÙ„ØµÙ‚</button><button id="imp-tab-excel" onclick="setImpTab('excel')" class="tab-btn">ğŸ“Š Ù…Ù„Ù Excel</button></div>
<div id="imp-paste-box"><p class="text-purple-300 text-xs mb-2">Ø§Ù„ØµÙ‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ (ÙƒÙ„ Ø³Ø·Ø± Ø³Ø¤Ø§Ù„):</p><p class="text-purple-400 text-xs mb-1" dir="ltr" style="font-family:monospace">Ø§Ù„Ø³Ø¤Ø§Ù„ | Ø§Ù„Ø®ÙŠØ§Ø± Ø£ | Ø§Ù„Ø®ÙŠØ§Ø± Ø¨ | Ø§Ù„Ø®ÙŠØ§Ø± Ø¬ | Ø§Ù„Ø®ÙŠØ§Ø± Ø¯ | Ø±Ù‚Ù… Ø§Ù„ØµØ­ÙŠØ­Ø© (1-4)</p><p class="text-purple-400 text-xs mb-3" dir="ltr" style="font-family:monospace">Ù…Ø«Ø§Ù„: Ù…Ø§ Ù‡Ùˆ ChatGPTØŸ | Ø±ÙˆØ¨ÙˆØª | Ù†Ù…ÙˆØ°Ø¬ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ | Ù„Ø¹Ø¨Ø© | Ù…ØªØµÙØ­ | 2</p><textarea id="imp-text" class="inp w-full h-40 text-sm" dir="auto" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‡Ù†Ø§..."></textarea></div>
<div id="imp-excel-box" class="hidden"><p class="text-purple-300 text-xs mb-2">Ø§Ø±ÙØ¹ Ù…Ù„Ù Excel (.xlsx / .csv) Ø¨Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ø§Ù„Ø³Ø¤Ø§Ù„ØŒ Ø£ØŒ Ø¨ØŒ Ø¬ØŒ Ø¯ØŒ Ø§Ù„ØµØ­ÙŠØ­Ø© (1-4)</p><input type="file" id="imp-file" accept=".xlsx,.xls,.csv" onchange="parseFile(this)" class="inp text-sm"><div id="imp-preview" class="mt-3"></div></div></div>
<div class="flex gap-2 justify-end"><button onclick="closeImport()" class="btn-s">Ø¥Ù„ØºØ§Ø¡</button><button onclick="doImport()" class="btn-p">âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button></div></div></div>
<div id="confetti-box" class="fixed inset-0 pointer-events-none z-[200]"></div>
<script>
var SB='https://xsutqujynlgeytzfoqbs.supabase.co',SK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzdXRxdWp5bmxnZXl0emZvcWJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzODc0NzUsImV4cCI6MjA4Njk2MzQ3NX0.crGJYQfuRO8282TuP-o6S9H0rsgToAWHHnOOb3a6RnI';
var OC=['from-rose-500 to-pink-600','from-blue-500 to-indigo-600','from-emerald-500 to-teal-600','from-amber-500 to-orange-600'];
var sb,GC='',isHost=false,myName='',myId=null,myScore=0,myCC=0,myTT=0,myPW={extend:false,auto:false,eliminate:false};
var qi=0,tl=20,tmr=null,pAns=false,ac=null,totalPlayers=0,answeredCount=0,hostTimerDone=false;
var hPL=null,hPA=null,pPS=null;
var adminId=null,adminName='',curGameId=null,curGameData=null,gameQuestions=[];
var GTIME=20,GPTS=10;
var SCRS=['scr-loading','scr-role','scr-instructions','scr-admin-login','scr-dashboard','scr-editor','scr-reports','scr-host-lobby','scr-host-game','scr-host-mid','scr-join','scr-wait','scr-player-q','scr-player-wait-next','scr-final'];
function scr(id){SCRS.forEach(function(s){document.getElementById(s).classList.add('hidden')});document.getElementById(id).classList.remove('hidden');scrollTo(0,0)}
function clr(){[hPL,hPA,pPS,tmr].forEach(function(i){if(i)clearInterval(i)});hPL=hPA=pPS=tmr=null}

window.addEventListener('load',async function(){scr('scr-loading');try{sb=window.supabase.createClient(SB,SK);var r=await sb.from('quiz_admins').select('id').limit(1);document.getElementById('load-txt').textContent='âœ…';await new Promise(function(r){setTimeout(r,300)});var jc=new URLSearchParams(location.search).get('join');if(jc){scr('scr-join');document.getElementById('inp-code').value=jc}else scr('scr-role')}catch(e){document.getElementById('load-txt').innerHTML='<span class="text-red-400">âŒ '+(e.message||'')+'</span><br><button onclick="location.reload()" class="btn-p mt-3">ğŸ”„</button>'}});
function pickRole(r){scr('scr-join')}
var authMode='login';
function setAuthTab(m){authMode=m;document.getElementById('tab-login').className='tab-btn'+(m==='login'?' active':'');document.getElementById('tab-reg').className='tab-btn'+(m==='register'?' active':'');document.getElementById('auth-reg-fields').classList.toggle('hidden',m==='login');document.getElementById('auth-btn').textContent=m==='login'?'Ø¯Ø®ÙˆÙ„':'ØªØ³Ø¬ÙŠÙ„'}
async function doAuth(){var u=document.getElementById('a-user').value.trim(),p=document.getElementById('a-pass').value.trim(),m=document.getElementById('auth-msg');if(!u||!p){m.className='text-sm mt-3 text-center text-red-400';m.textContent='âŒ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';return}if(authMode==='register'){var dn=document.getElementById('a-dname').value.trim();if(!dn){m.className='text-sm mt-3 text-center text-red-400';m.textContent='âŒ Ø§Ù„Ø§Ø³Ù…';return}var r=await sb.from('quiz_admins').insert({username:u,password:p,display_name:dn}).select().single();if(r.error){m.className='text-sm mt-3 text-center text-red-400';m.textContent=r.error.message.includes('duplicate')?'âŒ Ù…ÙˆØ¬ÙˆØ¯':'âŒ '+r.error.message;return}adminId=r.data.id;adminName=r.data.display_name;loadDashboard()}else{var r=await sb.from('quiz_admins').select('*').eq('username',u).eq('password',p).single();if(r.error||!r.data){m.className='text-sm mt-3 text-center text-red-400';m.textContent='âŒ Ø®Ø·Ø£';return}adminId=r.data.id;adminName=r.data.display_name;loadDashboard()}}
function adminLogout(){adminId=null;scr('scr-role')}
async function loadDashboard(){scr('scr-dashboard');document.getElementById('dash-welcome').textContent='Ù…Ø±Ø­Ø¨Ø§Ù‹ '+adminName;var r=await sb.from('quiz_games').select('*').eq('admin_id',adminId).order('created_at',{ascending:false});var g=r.data||[];var el=document.getElementById('games-list');if(!g.length){el.innerHTML='<p class="text-purple-400 text-sm text-center py-4">Ù„Ø§ Ø£Ù„Ø¹Ø§Ø¨</p>';return}el.innerHTML=g.map(function(x){var sc=x.status==='active'?'bg-emerald-500/20 text-emerald-300':x.status==='draft'?'bg-yellow-500/20 text-yellow-300':'bg-red-500/20 text-red-300';var sl=x.status==='active'?'Ù†Ø´Ø·Ø©':x.status==='draft'?'Ù…Ø³ÙˆØ¯Ø©':'Ù…Ù†ØªÙ‡ÙŠØ©';return '<div class="flex items-center justify-between p-4 rounded-xl bg-white/5 cursor-pointer hover:bg-white/8" onclick="openEditor(\''+x.id+'\')"><div><p class="text-white font-bold text-sm">'+x.title+'</p><div class="flex gap-2 mt-1 flex-wrap"><span class="badge '+sc+'">'+sl+'</span><span class="text-purple-400 text-xs">'+x.points_per_question+'Ù†</span><span class="text-purple-400 text-xs">'+x.time_per_question+'Ø«</span><span class="text-purple-400 text-xs">ÙƒÙˆØ¯:'+x.game_code+'</span></div></div><span class="text-purple-400">â†</span></div>'}).join('')}
async function createNewGame(){var c=String(Math.floor(1000+Math.random()*9000));var r=await sb.from('quiz_games').insert({admin_id:adminId,game_code:c,title:'Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©',points_per_question:10,time_per_question:20,status:'draft'}).select().single();if(!r.error)openEditor(r.data.id)}
async function openEditor(gid){curGameId=gid;scr('scr-editor');var r=await sb.from('quiz_games').select('*').eq('id',gid).single();curGameData=r.data;document.getElementById('ge-title').value=r.data.title;document.getElementById('ge-points').value=r.data.points_per_question;document.getElementById('ge-time').value=r.data.time_per_question;document.getElementById('ge-status').value=r.data.status;if(r.data.active_from)document.getElementById('ge-from').value=r.data.active_from.slice(0,16);if(r.data.active_to)document.getElementById('ge-to').value=r.data.active_to.slice(0,16);loadQs()}
async function loadQs(){var r=await sb.from('quiz_questions').select('*').eq('game_id',curGameId).order('sort_order');gameQuestions=r.data||[];renQs()}
function esc(s){return s?s.replace(/"/g,'&quot;').replace(/'/g,'&#39;'):''}
function renQs(){var el=document.getElementById('questions-editor');document.getElementById('q-count-badge').textContent=gameQuestions.length;if(!gameQuestions.length){el.innerHTML='<p class="text-purple-400 text-sm text-center py-4">Ø£Ø¶Ù Ø³Ø¤Ø§Ù„Ø§Ù‹</p>';return}el.innerHTML=gameQuestions.map(function(q,i){return '<div class="cg rounded-xl p-4"><div class="flex items-center justify-between mb-2"><span class="badge bg-purple-500/30 text-purple-300">Ø³'+(i+1)+'</span><button onclick="delQ(\''+q.id+'\')" class="btn-d">ğŸ—‘ï¸</button></div><input class="inp mb-2 text-sm" value="'+esc(q.question_text)+'" onchange="updQ(\''+q.id+'\',\'question_text\',this.value)" placeholder="Ø§Ù„Ø³Ø¤Ø§Ù„"><div class="grid grid-cols-2 gap-2 mb-2"><input class="inp text-xs" value="'+esc(q.option_a)+'" onchange="updQ(\''+q.id+'\',\'option_a\',this.value)" placeholder="Ø£"><input class="inp text-xs" value="'+esc(q.option_b)+'" onchange="updQ(\''+q.id+'\',\'option_b\',this.value)" placeholder="Ø¨"><input class="inp text-xs" value="'+esc(q.option_c)+'" onchange="updQ(\''+q.id+'\',\'option_c\',this.value)" placeholder="Ø¬"><input class="inp text-xs" value="'+esc(q.option_d)+'" onchange="updQ(\''+q.id+'\',\'option_d\',this.value)" placeholder="Ø¯"></div><select class="inp text-xs" style="width:auto" onchange="updQ(\''+q.id+'\',\'correct_option\',+this.value)"><option value="0"'+(q.correct_option===0?' selected':'')+'>Ø£âœ“</option><option value="1"'+(q.correct_option===1?' selected':'')+'>Ø¨âœ“</option><option value="2"'+(q.correct_option===2?' selected':'')+'>Ø¬âœ“</option><option value="3"'+(q.correct_option===3?' selected':'')+'>Ø¯âœ“</option></select></div>'}).join('')}
async function addQuestion(){var r=await sb.from('quiz_questions').insert({game_id:curGameId,question_text:'',option_a:'',option_b:'',option_c:'',option_d:'',correct_option:0,sort_order:gameQuestions.length}).select().single();if(!r.error){gameQuestions.push(r.data);renQs()}}
async function delQ(id){await sb.from('quiz_questions').delete().eq('id',id);gameQuestions=gameQuestions.filter(function(q){return q.id!==id});renQs()}
async function updQ(id,f,v){var u={};u[f]=v;await sb.from('quiz_questions').update(u).eq('id',id);var q=gameQuestions.find(function(x){return x.id===id});if(q)q[f]=v}
async function saveGameSettings(){var u={title:document.getElementById('ge-title').value,points_per_question:parseInt(document.getElementById('ge-points').value)||10,time_per_question:parseInt(document.getElementById('ge-time').value)||20,status:document.getElementById('ge-status').value};var f=document.getElementById('ge-from').value,t=document.getElementById('ge-to').value;if(f)u.active_from=new Date(f).toISOString();if(t)u.active_to=new Date(t).toISOString();await sb.from('quiz_games').update(u).eq('id',curGameId);curGameData=Object.assign(curGameData,u);floatTxt('âœ… Ø­ÙØ¸!','#34d399')}
var _aiData=null;
// === REPORTS ===
async function openReports(){if(!curGameId)return;scr('scr-reports');
  var rr=await sb.from('quiz_responses').select('*').eq('game_id',curGameId).order('created_at');var resp=rr.data||[];
  // Build players from responses (not quiz_players which gets deleted on restart)
  var pMap={};resp.forEach(function(r){if(!pMap[r.player_name])pMap[r.player_name]={name:r.player_name,score:0,correct:0,time:0,responses:[]};pMap[r.player_name].score+=r.points_earned;if(r.is_correct){pMap[r.player_name].correct++;pMap[r.player_name].time+=r.answer_time}pMap[r.player_name].responses.push(r)});
  var players=Object.values(pMap);
  var totalQ=gameQuestions.length,totalP=players.length,totalR=resp.length;
  var corrR=resp.filter(function(r){return r.is_correct}).length;
  var wrongR=totalR-corrR;
  var avgTime=totalR>0?(resp.reduce(function(s,r){return s+r.answer_time},0)/totalR).toFixed(1):0;
  var pct=totalR>0?Math.round(corrR/totalR*100):0;
  document.getElementById('stats-cards').innerHTML='<div class="stat-card cg asu"><div class="stat-num text-cyan-400">'+totalP+'</div><div class="stat-lbl text-cyan-300">Ù…Ø´Ø§Ø±Ùƒ</div></div><div class="stat-card cg asu" style="animation-delay:.05s"><div class="stat-num text-emerald-400">'+corrR+'</div><div class="stat-lbl text-emerald-300">ØµØ­ÙŠØ­Ø©</div></div><div class="stat-card cg asu" style="animation-delay:.1s"><div class="stat-num text-red-400">'+wrongR+'</div><div class="stat-lbl text-red-300">Ø®Ø§Ø·Ø¦Ø©</div></div><div class="stat-card cg asu" style="animation-delay:.15s"><div class="stat-num text-amber-400">'+pct+'%</div><div class="stat-lbl text-amber-300">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</div></div><div class="stat-card cg asu" style="animation-delay:.2s"><div class="stat-num text-purple-400">'+avgTime+'Ø«</div><div class="stat-lbl text-purple-300">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø²Ù…Ù†</div></div>';
  // Chart per question
  var chartHtml='';
  gameQuestions.forEach(function(q,i){
    var qR=resp.filter(function(r){return r.question_index===i});var qC=qR.filter(function(r){return r.is_correct}).length;
    var qT=qR.length;var qP=qT>0?Math.round(qC/qT*100):0;
    chartHtml+='<div class="bar-row"><div class="bar-label">Ø³'+(i+1)+'</div><div class="bar-bg"><div class="bar-fill '+(qP>=70?'bg-emerald-500':qP>=40?'bg-amber-500':'bg-red-500')+'" style="width:'+Math.max(qP,3)+'%"><span>'+qP+'%</span></div></div><div class="text-purple-400 text-xs" style="width:50px">'+qC+'/'+qT+'</div></div>';
  });
  document.getElementById('stats-chart').innerHTML=chartHtml||'<p class="text-purple-400 text-sm">Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
  // Players ranking table
  var sorted=players.sort(function(a,b){if(b.score!==a.score)return b.score-a.score;return a.time-b.time});
  var md=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  document.getElementById('rpt-players').innerHTML=sorted.map(function(p,i){var wr=p.responses.length-p.correct;var pc2=p.responses.length>0?Math.round(p.correct/p.responses.length*100):0;return '<tr><td class="font-bold">'+(md[i]||(i+1))+'</td><td class="text-white font-semibold">'+p.name+'</td><td class="text-amber-400 font-bold">'+p.score+'</td><td class="text-emerald-400">'+p.correct+'</td><td class="text-red-400">'+wr+'</td><td class="text-cyan-400">'+p.time.toFixed(1)+'Ø«</td><td><span class="badge '+(pc2>=70?'bg-emerald-500/20 text-emerald-300':pc2>=40?'bg-amber-500/20 text-amber-300':'bg-red-500/20 text-red-300')+'">'+pc2+'%</span></td></tr>'}).join('');
  // Responses table: ONE ROW per player, all questions as columns
  var qHeaders='';gameQuestions.forEach(function(q,i){qHeaders+='<th class="text-center" title="'+esc(q.question_text)+'">Ø³'+(i+1)+'</th>'});
  var rptHead='<tr><th>Ø§Ù„Ù„Ø§Ø¹Ø¨</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th><th>âœ“</th><th>âœ—</th><th>Ø§Ù„Ø²Ù…Ù†</th>'+qHeaders+'</tr>';
  var rptBody=sorted.map(function(p){
    var cells='<td class="text-white font-semibold">'+p.name+'</td><td class="text-amber-400 font-bold">'+p.score+'</td><td class="text-emerald-400">'+p.correct+'</td><td class="text-red-400">'+(p.responses.length-p.correct)+'</td><td class="text-cyan-400">'+p.time.toFixed(1)+'Ø«</td>';
    gameQuestions.forEach(function(q,i){
      var pr=p.responses.find(function(r){return r.question_index===i});
      if(!pr)cells+='<td class="text-center text-purple-500">â€”</td>';
      else if(pr.is_correct)cells+='<td class="text-center" style="background:rgba(52,211,153,.1)"><span class="text-emerald-400 font-bold text-lg">âœ“</span><br><span class="text-emerald-300" style="font-size:.65rem">'+pr.answer_time.toFixed(1)+'Ø«</span></td>';
      else cells+='<td class="text-center" style="background:rgba(248,113,113,.1)"><span class="text-red-400 font-bold text-lg">âœ—</span><br><span class="text-red-300" style="font-size:.65rem">'+pr.answer_time.toFixed(1)+'Ø«</span></td>';
    });
    return '<tr>'+cells+'</tr>';
  }).join('');
  var rptTable=document.getElementById('rpt-responses').parentElement.parentElement;
  rptTable.querySelector('thead').innerHTML=rptHead;
  document.getElementById('rpt-responses').innerHTML=rptBody||'<tr><td colspan="'+(5+gameQuestions.length)+'" class="text-center text-purple-400 py-4">Ù„Ø§ Ø§Ø³ØªØ¬Ø§Ø¨Ø§Øª</td></tr>';
  _aiData={r:resp,p:players,q:gameQuestions,tp:totalP,cr:corrR,wr:wrongR,at:avgTime,pc:pct};
  document.getElementById('ai-analysis').classList.add('hidden');
  document.getElementById('ai-btn').textContent='ğŸ” ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ';
}

function generateAI(resp,players,questions,tp,cr,wr,avgT,pct){
  var el=document.getElementById('ai-analysis');
  if(!resp.length){el.innerHTML='<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„ØªØ­Ù„ÙŠÙ„. Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹.</p>';return}
  var lines=[];
  lines.push('ğŸ“Œ <b>Ù…Ù„Ø®Øµ Ø¹Ø§Ù…:</b> Ø´Ø§Ø±Ùƒ '+tp+' Ù„Ø§Ø¹Ø¨ ÙˆØ£Ø¬Ø§Ø¨ÙˆØ§ Ø¹Ù„Ù‰ '+resp.length+' Ø¥Ø¬Ø§Ø¨Ø©. Ù†Ø³Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© '+pct+'% Ø¨Ù…ØªÙˆØ³Ø· Ø²Ù…Ù† '+avgT+' Ø«Ø§Ù†ÙŠØ©.');
  var qStats=[];
  questions.forEach(function(q,i){var qr=resp.filter(function(r){return r.question_index===i});var c=qr.filter(function(r){return r.is_correct}).length;var t=qr.length;qStats.push({i:i,txt:q.question_text||'',pct:t>0?Math.round(c/t*100):0,avg:t>0?(qr.reduce(function(s,r){return s+r.answer_time},0)/t).toFixed(1):0})});
  qStats.sort(function(a,b){return a.pct-b.pct});
  if(qStats.length>0){
    var hardest=qStats[0];var easiest=qStats[qStats.length-1];
    lines.push('');
    lines.push('ğŸ”´ <b>Ø£ØµØ¹Ø¨ Ø³Ø¤Ø§Ù„:</b> Ø³'+(hardest.i+1)+' ('+hardest.pct+'% ØµØ­ÙŠØ­Ø©) - "'+hardest.txt.substring(0,60)+'..."');
    lines.push('ğŸŸ¢ <b>Ø£Ø³Ù‡Ù„ Ø³Ø¤Ø§Ù„:</b> Ø³'+(easiest.i+1)+' ('+easiest.pct+'% ØµØ­ÙŠØ­Ø©) - "'+easiest.txt.substring(0,60)+'..."');
  }
  var totalQ=questions.length;
  var excellent=players.filter(function(p){return p.correct>=totalQ*0.8}).length;
  var good=players.filter(function(p){return p.correct>=totalQ*0.5&&p.correct<totalQ*0.8}).length;
  var weak=players.filter(function(p){return p.correct<totalQ*0.5}).length;
  lines.push('');
  lines.push('ğŸ“Š <b>Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡:</b>');
  lines.push('&nbsp;&nbsp;ğŸŒŸ Ù…Ù…ØªØ§Ø² (80%+): '+excellent+' Ù„Ø§Ø¹Ø¨');
  lines.push('&nbsp;&nbsp;ğŸ‘ Ø¬ÙŠØ¯ (50-79%): '+good+' Ù„Ø§Ø¹Ø¨');
  lines.push('&nbsp;&nbsp;ğŸ“ ÙŠØ­ØªØ§Ø¬ ØªØ·ÙˆÙŠØ± (Ø£Ù‚Ù„ Ù…Ù† 50%): '+weak+' Ù„Ø§Ø¹Ø¨');
  lines.push('');
  lines.push('ğŸ’¡ <b>ØªÙˆØµÙŠØ§Øª:</b>');
  if(pct<50)lines.push('â€¢ Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ù†Ø®ÙØ¶Ø©. ÙŠÙÙ†ØµØ­ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© ØµÙŠØ§ØºØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø£Ùˆ ØªÙ‚Ø¯ÙŠÙ… Ù…Ø­ØªÙˆÙ‰ ØªØ¹Ù„ÙŠÙ…ÙŠ.');
  else if(pct<70)lines.push('â€¢ Ø£Ø¯Ø§Ø¡ Ù…ØªÙˆØ³Ø·. ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡ Ø¨ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØµØ¹Ø¨Ø©.');
  else lines.push('â€¢ Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø²! Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† ÙŠÙ…Ù„ÙƒÙˆÙ† ÙÙ‡Ù…Ø§Ù‹ Ø¬ÙŠØ¯Ø§Ù‹ Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.');
  var slowQs=qStats.filter(function(q){return parseFloat(q.avg)>parseFloat(avgT)*1.3});
  if(slowQs.length>0)lines.push('â€¢ Ø£Ø³Ø¦Ù„Ø© Ø§Ø³ØªØºØ±Ù‚Øª ÙˆÙ‚ØªØ§Ù‹ Ø£Ø·ÙˆÙ„: '+slowQs.map(function(q){return 'Ø³'+(q.i+1)}).join('ØŒ '));
  if(players.length>0){var best=players.sort(function(a,b){return b.score-a.score})[0];lines.push('â€¢ ğŸ† Ø£ÙØ¶Ù„ Ø£Ø¯Ø§Ø¡: <b>'+best.name+'</b> Ø¨Ù€ '+best.score+' Ù†Ù‚Ø·Ø© Ùˆ '+best.correct+' Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ÙÙŠ '+best.time.toFixed(1)+'Ø«');}
  var fastC=resp.filter(function(r){return r.is_correct&&r.answer_time<=5}).length;
  var slowC=resp.filter(function(r){return r.is_correct&&r.answer_time>10}).length;
  lines.push('');
  lines.push('âš¡ <b>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø±Ø¹Ø©:</b> '+fastC+' Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© Ø³Ø±ÙŠØ¹Ø© (Ø£Ù‚Ù„ Ù…Ù† 5Ø«)ØŒ '+slowC+' Ø¨Ø·ÙŠØ¦Ø© (Ø£ÙƒØ«Ø± Ù…Ù† 10Ø«).');
  el.innerHTML=lines.join('<br>');
}
function runAI(){var el=document.getElementById('ai-analysis');el.classList.remove('hidden');document.getElementById('ai-btn').textContent='âœ… ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„';if(_aiData)generateAI(_aiData.r,_aiData.p,_aiData.q,_aiData.tp,_aiData.cr,_aiData.wr,_aiData.at,_aiData.pc)}

function exportCSV(){
  var thead=document.querySelector('#rpt-responses').parentElement.parentElement.querySelector('thead');
  var hCells=[];for(var h=0;h<thead.rows[0].cells.length;h++)hCells.push('"'+thead.rows[0].cells[h].textContent.trim()+'"');
  var rows=[hCells.join(',')];
  var tbl=document.getElementById('rpt-responses');
  for(var i=0;i<tbl.rows.length;i++){var cells=[];for(var j=0;j<tbl.rows[i].cells.length;j++){cells.push('"'+tbl.rows[i].cells[j].textContent.trim().replace(/"/g,'""')+'"')}rows.push(cells.join(','))}
  var blob=new Blob(['\uFEFF'+rows.join('\n')],{type:'text/csv;charset=utf-8'});var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='quiz-report-'+curGameData.game_code+'.csv';a.click();
}
// === HOST ===
async function startHosting(){if(!curGameId||!gameQuestions.length){floatTxt('âŒ Ø£Ø¶Ù Ø£Ø³Ø¦Ù„Ø©','#f87171');return}await saveGameSettings();GC=curGameData.game_code;GTIME=curGameData.time_per_question;GPTS=curGameData.points_per_question;isHost=true;scr('scr-host-lobby');document.getElementById('h-code').textContent=GC;document.getElementById('hl-title').textContent='ğŸ‘¨â€ğŸ« '+curGameData.title;document.getElementById('hl-info').textContent=gameQuestions.length+' Ø³Ø¤Ø§Ù„ â€¢ '+GPTS+' Ù†Ù‚Ø·Ø© â€¢ '+GTIME+'Ø«';var qe=document.getElementById('qr-box');qe.innerHTML='';new QRCode(qe,{text:location.origin+location.pathname+'?join='+GC,width:160,height:160,colorDark:'#1a0a2e',colorLight:'#fff',correctLevel:QRCode.CorrectLevel.H});
  // Clean old players only (keep responses for reports)
  await sb.from('quiz_players').delete().eq('game_code',GC);
  await sb.from('quiz_players').insert({game_code:GC,player_name:'Ù…Ø¶ÙŠÙ',is_host:true,score:0,correct_count:0,total_time:0,status:'lobby',powerups:{},current_answer:-1,answer_time:0,game_id:curGameId});hostRefresh();hPL=setInterval(hostRefresh,1500)}
async function hostRefresh(){var r=await sb.from('quiz_players').select('*').eq('game_code',GC).eq('is_host',false).order('created_at');var l=r.data||[];totalPlayers=l.length;var c=document.getElementById('h-players'),b=document.getElementById('h-count');if(!c)return;if(!l.length)c.innerHTML='<p class="text-purple-400 text-sm text-center py-4 awp">â³</p>';else c.innerHTML=l.map(function(p,i){return '<div class="flex items-center justify-between p-3 rounded-xl bg-white/5 are"><div class="flex items-center gap-3"><span class="w-7 h-7 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-white text-xs font-bold">'+(i+1)+'</span><span class="text-white font-semibold text-sm">'+p.player_name+'</span></div><span class="sd"></span></div>'}).join('');if(b)b.textContent=l.length;var btn=document.getElementById('h-start-btn');if(btn)btn.disabled=!l.length}
async function hostSendStart(){if(hPL){clearInterval(hPL);hPL=null}qi=0;await sb.from('quiz_players').update({score:0,correct_count:0,total_time:0,current_answer:-1,answer_time:0,status:'playing'}).eq('game_code',GC).eq('is_host',false);await sb.from('quiz_players').update({status:'q_0'}).eq('game_code',GC).eq('is_host',true);scr('scr-host-game');hostShowQ()}
function hostShowQ(){if(qi>=gameQuestions.length){hostEnd();return}var q=gameQuestions[qi];var opts=[q.option_a,q.option_b,q.option_c,q.option_d];answeredCount=0;hostTimerDone=false;document.getElementById('hg-qnum').textContent=(qi+1)+'/'+gameQuestions.length;document.getElementById('hg-pts').textContent=GPTS+'Ù†';document.getElementById('hg-qtxt').textContent=q.question_text;document.getElementById('hg-prog').style.width=((qi+1)/gameQuestions.length*100)+'%';document.getElementById('hg-ans-count').textContent='0/'+totalPlayers;document.getElementById('hg-ans-bar').style.width='0%';document.getElementById('hg-next-btn').classList.add('hidden');document.getElementById('hg-show-btn').classList.add('hidden');document.getElementById('hg-opts').innerHTML=opts.map(function(op,i){return '<div class="p-4 rounded-2xl bg-gradient-to-br '+OC[i]+' text-white font-bold text-lg shadow-lg opacity-80 asu" style="animation-delay:'+i*60+'ms">'+op+'</div>'}).join('');tl=GTIME;hTmStart();if(hPA)clearInterval(hPA);hPA=setInterval(hChkAns,1000)}
function hTmStart(){updHT();tmr=setInterval(function(){tl--;updHT();if(tl<=0){clearInterval(tmr);tmr=null;hTUp()}},1000)}
function updHT(){var n=document.getElementById('hg-timer'),b=document.getElementById('hg-timer-box');n.textContent=tl;if(tl<=5){b.classList.add('atp');n.classList.add('text-red-200');n.classList.remove('text-white')}else{b.classList.remove('atp');n.classList.remove('text-red-200');n.classList.add('text-white')}}
async function hChkAns(){try{var r=await sb.from('quiz_players').select('current_answer').eq('game_code',GC).eq('is_host',false);var d=r.data||[];totalPlayers=d.length;answeredCount=d.filter(function(p){return p.current_answer!==-1}).length;document.getElementById('hg-ans-count').textContent=answeredCount+'/'+totalPlayers;document.getElementById('hg-ans-bar').style.width=totalPlayers?(answeredCount/totalPlayers*100)+'%':'0%';if(answeredCount>=totalPlayers&&totalPlayers>0&&!hostTimerDone){if(tmr){clearInterval(tmr);tmr=null}hTUp()}}catch(e){}}
async function hTUp(){if(hostTimerDone)return;hostTimerDone=true;if(hPA){clearInterval(hPA);hPA=null}var q=gameQuestions[qi];var opts=[q.option_a,q.option_b,q.option_c,q.option_d];document.getElementById('hg-opts').innerHTML=opts.map(function(op,i){return '<div class="p-4 rounded-2xl bg-gradient-to-br '+(i===q.correct_option?'from-emerald-400 to-green-500 ring-4 ring-white ace':'from-gray-600 to-gray-700 opacity-50')+' text-white font-bold text-lg shadow-lg asu">'+(i===q.correct_option?'âœ… ':'')+op+'</div>'}).join('');document.getElementById('hg-next-btn').classList.remove('hidden');document.getElementById('hg-show-btn').classList.remove('hidden');await hChkAns();await sb.from('quiz_players').update({status:'timeup_'+qi}).eq('game_code',GC).eq('is_host',true)}
function sortP(d){return d.sort(function(a,b){if(b.score!==a.score)return b.score-a.score;return a.total_time-b.total_time})}
async function hostShowLB(){var r=await sb.from('quiz_players').select('*').eq('game_code',GC).eq('is_host',false);var s=sortP(r.data||[]);scr('scr-host-mid');document.getElementById('hm-info').textContent='Ø¨Ø¹Ø¯ Ø³'+(qi+1)+'/'+gameQuestions.length;var md=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];document.getElementById('hm-ranks').innerHTML=s.map(function(p,i){return '<div class="flex items-center justify-between p-4 rounded-xl '+(i===0?'bg-gradient-to-r from-yellow-500/20 to-amber-500/20':'bg-white/5')+' are"><div class="flex items-center gap-3"><span class="text-2xl w-8 text-center">'+(md[i]||(i+1))+'</span><span class="text-white font-bold text-sm">'+p.player_name+'</span></div><span class="font-black '+(i===0?'text-yellow-400':'text-white')+'">'+p.score+'</span></div>'}).join('')}
async function hostNextQ(){qi++;if(qi>=gameQuestions.length){hostEnd();return}await sb.from('quiz_players').update({current_answer:-1,answer_time:0}).eq('game_code',GC).eq('is_host',false);await sb.from('quiz_players').update({status:'q_'+qi}).eq('game_code',GC).eq('is_host',true);answeredCount=0;scr('scr-host-game');hostShowQ()}
async function hostEnd(){clr();await sb.from('quiz_players').update({status:'finished'}).eq('game_code',GC).eq('is_host',true);showFinal()}
// === PLAYER ===
async function joinGame(){var n=document.getElementById('inp-name').value.trim(),co=document.getElementById('inp-code').value.trim(),m=document.getElementById('join-msg');if(!n){m.className='text-sm mt-3 text-center text-red-400';m.textContent='âŒ Ø§Ø³Ù…Ùƒ';return}if(co.length!==4){m.className='text-sm mt-3 text-center text-red-400';m.textContent='âŒ 4 Ø£Ø±Ù‚Ø§Ù…';return}m.className='text-sm mt-3 text-center text-purple-300';m.textContent='â³';
  var hr=await sb.from('quiz_players').select('id,game_id').eq('game_code',co).eq('is_host',true).limit(1);if(!hr.data||!hr.data.length){m.className='text-sm mt-3 text-center text-red-400';m.textContent='âŒ Ù„Ø§ ØªÙˆØ¬Ø¯';return}
  var gid=hr.data[0].game_id;if(gid){var gr=await sb.from('quiz_games').select('*').eq('id',gid).single();if(gr.data){GTIME=gr.data.time_per_question;GPTS=gr.data.points_per_question;var now=new Date();if(gr.data.active_from&&new Date(gr.data.active_from)>now){m.className='text-sm mt-3 text-center text-red-400';m.textContent='âŒ Ù„Ù… ØªØ¨Ø¯Ø£';return}if(gr.data.active_to&&new Date(gr.data.active_to)<now){m.className='text-sm mt-3 text-center text-red-400';m.textContent='âŒ Ø§Ù†ØªÙ‡Øª';return}}var qr=await sb.from('quiz_questions').select('*').eq('game_id',gid).order('sort_order');gameQuestions=qr.data||[];curGameId=gid;curGameData=gr.data}
  var ir=await sb.from('quiz_players').insert({game_code:co,player_name:n,is_host:false,score:0,correct_count:0,total_time:0,status:'joined',powerups:{extend:false,auto:false,eliminate:false},current_answer:-1,answer_time:0,game_id:gid}).select().single();
  if(ir.error){m.className='text-sm mt-3 text-center text-red-400';m.textContent='âŒ '+ir.error.message;return}
  myName=n;myId=ir.data.id;GC=co;myScore=0;myCC=0;myTT=0;myPW={extend:false,auto:false,eliminate:false};scr('scr-wait');document.getElementById('w-name').textContent='Ù…Ø±Ø­Ø¨Ø§Ù‹ '+n;pPS=setInterval(pChk,800)}
var lastH='';
async function pChk(){try{var r=await sb.from('quiz_players').select('status').eq('game_code',GC).eq('is_host',true).limit(1);if(!r.data||!r.data.length)return;var st=r.data[0].status;if(st===lastH)return;lastH=st;if(st.indexOf('q_')===0){qi=parseInt(st.split('_')[1]);pAns=false;if(tmr){clearInterval(tmr);tmr=null}initA();scr('scr-player-q');pShowQ()}else if(st.indexOf('timeup_')===0){if(tmr){clearInterval(tmr);tmr=null}if(!pAns)pTO();setTimeout(function(){scr('scr-player-wait-next');document.getElementById('pwn-score').textContent=myScore;document.getElementById('pwn-correct').textContent=myCC},2200)}else if(st==='finished'){clr();showFinal()}}catch(e){}}
function pShowQ(){if(qi>=gameQuestions.length)return;var q=gameQuestions[qi];var opts=[q.option_a,q.option_b,q.option_c,q.option_d];pAns=false;document.getElementById('pq-num').textContent=(qi+1)+'/'+gameQuestions.length;document.getElementById('pq-score').textContent=myScore+'Ù†';document.getElementById('pq-txt').textContent=q.question_text;document.getElementById('pq-prog').style.width=((qi+1)/gameQuestions.length*100)+'%';updPW();var h='';for(var i=0;i<opts.length;i++){h+='<button id="opt-'+i+'" onclick="pAnsQ('+i+')" class="ob p-4 rounded-2xl bg-gradient-to-br '+OC[i]+' text-white font-bold text-lg shadow-lg asu" style="animation-delay:'+i*60+'ms">'+opts[i]+'</button>'}document.getElementById('pq-opts').innerHTML=h;tl=GTIME;pTmStart()}
function pTmStart(){updPT();tmr=setInterval(function(){tl--;updPT();if(tl<=10&&tl>0)playTk();if(tl<=0){clearInterval(tmr);tmr=null;if(!pAns)pTO()}},1000)}
function updPT(){var n=document.getElementById('pq-timer'),b=document.getElementById('pq-timer-box');n.textContent=tl;if(tl<=5){b.classList.add('atp');n.classList.add('text-red-200');n.classList.remove('text-white')}else{b.classList.remove('atp');n.classList.remove('text-red-200');n.classList.add('text-white')}}
function updPW(){['extend','auto','eliminate'].forEach(function(t){var b=document.getElementById('pw-'+t);if(myPW[t]){b.classList.add('used');b.disabled=true}else{b.classList.remove('used');b.disabled=false}})}
function usePW(t){if(pAns||myPW[t])return;myPW[t]=true;document.getElementById('pw-'+t).classList.add('used');document.getElementById('pw-'+t).disabled=true;playPU();
  if(t==='extend'){tl+=10;updPT();floatTxt('â±ï¸+10','#22d3ee')}
  else if(t==='auto'){if(tmr){clearInterval(tmr);tmr=null}var q=gameQuestions[qi];pAns=true;var tt=GTIME-tl;myScore+=GPTS;myCC++;myTT+=tt;for(var i=0;i<4;i++){var btn=document.getElementById('opt-'+i);if(btn){btn.disabled=true;if(i===q.correct_option)btn.className='ob p-4 rounded-2xl bg-gradient-to-br from-emerald-400 to-green-500 text-white font-bold text-lg shadow-lg ring-4 ring-white ace'}}playOK();showPR(true,GPTS);floatTxt('âœ¨','#a3e635');sendA(q.correct_option,tt,true)}
  else if(t==='eliminate'){var q=gameQuestions[qi];var w=[];for(var i=0;i<4;i++){if(i!==q.correct_option)w.push(i)}for(var j=w.length-1;j>0;j--){var k=Math.floor(Math.random()*(j+1));var tmp=w[j];w[j]=w[k];w[k]=tmp}for(var x=0;x<2;x++){var btn=document.getElementById('opt-'+w[x]);if(btn){btn.classList.add('opt-hidden');btn.disabled=true}}floatTxt('ğŸš« 50/50','#f472b6')}}
function pAnsQ(idx){if(pAns)return;pAns=true;if(tmr){clearInterval(tmr);tmr=null}var q=gameQuestions[qi],ok=(idx===q.correct_option),tt=GTIME-tl;for(var i=0;i<4;i++){var btn=document.getElementById('opt-'+i);if(btn){btn.disabled=true;if(i===q.correct_option)btn.className='ob p-4 rounded-2xl bg-gradient-to-br from-emerald-400 to-green-500 text-white font-bold text-lg shadow-lg ring-4 ring-white ace';else if(i===idx&&!ok)btn.className='ob p-4 rounded-2xl bg-gradient-to-br from-red-500 to-red-700 text-white font-bold text-lg shadow-lg ash'}}if(ok){myScore+=GPTS;myCC++;myTT+=tt;playOK()}else{playNG()}showPR(ok,ok?GPTS:0);sendA(idx,tt,ok)}
function pTO(){if(pAns)return;pAns=true;var q=gameQuestions[qi];for(var i=0;i<4;i++){var btn=document.getElementById('opt-'+i);if(btn){btn.disabled=true;if(i===q.correct_option)btn.classList.add('ring-4','ring-white')}}playNG();showPR(false,0,true);sendA(-2,GTIME,false)}
async function sendA(idx,tt,ok){
  var ud={current_answer:idx,answer_time:tt,score:myScore,correct_count:myCC,total_time:myTT,powerups:myPW};
  // Save player state
  for(var a=0;a<3;a++){try{var r=await sb.from('quiz_players').update(ud).eq('id',myId).select();if(!r.error)break}catch(e){}await new Promise(function(r){setTimeout(r,500)})}
  // Save response for reports (separate call, no retry to avoid duplicates)
  try{var q=gameQuestions[qi];await sb.from('quiz_responses').insert({game_id:curGameId,game_code:GC,player_id:myId,player_name:myName,question_id:q.id,question_text:q.question_text,question_index:qi,selected_answer:idx,correct_answer:q.correct_option,is_correct:!!ok,answer_time:tt,points_earned:ok?GPTS:0})}catch(e){console.log('resp save err',e)}}
function showPR(ok,pt,to){var ov=document.getElementById('pq-result'),cd=document.getElementById('pq-res-card');document.getElementById('pq-res-emoji').textContent=to?'â°':(ok?'ğŸ‰':'ğŸ˜¢');document.getElementById('pq-res-txt').textContent=to?'Ø§Ù†ØªÙ‡Ù‰!':(ok?'ØµØ­ÙŠØ­Ø©!':'Ø®Ø§Ø·Ø¦Ø©!');document.getElementById('pq-res-pts').textContent=ok?'+'+pt:'';ov.classList.remove('hidden');requestAnimationFrame(function(){cd.style.transform='scale(1)'});if(ok)confetti(8);setTimeout(function(){cd.style.transform='scale(0)';setTimeout(function(){ov.classList.add('hidden')},300)},2000)}
async function showFinal(){clr();var r=await sb.from('quiz_players').select('*').eq('game_code',GC).eq('is_host',false);var s=sortP(r.data||[]);scr('scr-final');confetti(40);var po=document.getElementById('fin-podium'),md=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];if(s.length>=3){var o=[s[1],s[0],s[2]],h=['h-24','h-36','h-20'],me=['ğŸ¥ˆ','ğŸ¥‡','ğŸ¥‰'],bg=['from-gray-300/20 to-gray-400/20','from-yellow-300/20 to-amber-400/20','from-orange-400/20 to-orange-500/20'];po.innerHTML=o.map(function(p,i){return '<div class="flex flex-col items-center asu" style="animation-delay:'+i*200+'ms"><span class="text-5xl mb-2">'+me[i]+'</span><p class="text-white font-bold text-sm truncate max-w-[80px]">'+p.player_name+'</p><p class="text-yellow-300 font-black text-xl">'+p.score+'</p><div class="'+h[i]+' w-24 rounded-t-xl bg-gradient-to-t '+bg[i]+' mt-2 flex items-end justify-center pb-2"><span class="text-white/60 text-xs">â±'+p.total_time.toFixed(1)+'</span></div></div>'}).join('')}else po.innerHTML=s.map(function(p,i){return '<div class="flex flex-col items-center asu"><span class="text-5xl mb-2">'+(md[i]||'')+'</span><p class="text-white font-bold">'+p.player_name+'</p><p class="text-yellow-300 font-black text-2xl">'+p.score+'</p></div>'}).join('');document.getElementById('fin-ranks').innerHTML=s.map(function(p,i){return '<div class="flex items-center justify-between p-3 rounded-xl '+(i===0?'bg-gradient-to-r from-yellow-500/20 to-amber-500/20':'bg-white/5')+' are"><div class="flex items-center gap-3"><span class="text-xl w-8 text-center">'+(md[i]||(i+1))+'</span><div><p class="text-white font-bold text-sm">'+p.player_name+'</p><p class="text-purple-400 text-xs">'+p.score+'Ù† â€¢ âœ“'+p.correct_count+' â€¢ â±'+p.total_time.toFixed(1)+'Ø«</p></div></div><span class="font-black '+(i===0?'text-yellow-400':'text-white')+'">'+p.score+'</span></div>'}).join('')}
// === QR/AUDIO/HELPERS ===
var qrs=null,qri=null;
function openQR(){var v=document.getElementById('qr-video'),o=document.getElementById('qr-overlay');v.classList.remove('hidden');o.classList.remove('hidden');navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(function(s){qrs=s;v.srcObject=s;v.play();doScan(v)}).catch(function(){closeQR()})}
function doScan(v){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';s.onload=function(){var cv=document.createElement('canvas'),cx=cv.getContext('2d');qri=setInterval(function(){if(v.readyState===v.HAVE_ENOUGH_DATA){cv.width=v.videoWidth;cv.height=v.videoHeight;cx.drawImage(v,0,0);var d=cx.getImageData(0,0,cv.width,cv.height),r=window.jsQR(d.data,cv.width,cv.height);if(r){closeQR();try{var u=new URL(r.data),jc=u.searchParams.get('join');if(jc){document.getElementById('inp-code').value=jc;if(document.getElementById('inp-name').value.trim())joinGame();else document.getElementById('inp-name').focus()}}catch(e){}}}},150)};document.head.appendChild(s)}
function closeQR(){if(qri){clearInterval(qri);qri=null}if(qrs){qrs.getTracks().forEach(function(t){t.stop()});qrs=null}document.getElementById('qr-video').classList.add('hidden');document.getElementById('qr-overlay').classList.add('hidden')}
function initA(){if(!ac)ac=new(window.AudioContext||window.webkitAudioContext)()}
function tone(f,d,t,v){if(!ac)return;t=t||'sine';v=v||.2;try{var o=ac.createOscillator(),g=ac.createGain();o.connect(g);g.connect(ac.destination);o.frequency.value=f;o.type=t;g.gain.setValueAtTime(v,ac.currentTime);g.gain.exponentialRampToValueAtTime(.001,ac.currentTime+d);o.start();o.stop(ac.currentTime+d)}catch(e){}}
function playTk(){tone(tl<=5?880:440,.08)}function playOK(){tone(523,.12);setTimeout(function(){tone(659,.12)},70);setTimeout(function(){tone(784,.18)},140)}function playNG(){tone(200,.25,'sawtooth',.12)}function playPU(){tone(880,.08);setTimeout(function(){tone(1100,.1)},50);setTimeout(function(){tone(1320,.15)},100)}
function floatTxt(t,c){var d=document.createElement('div');d.className='asu';d.style.cssText='position:fixed;top:35%;left:50%;transform:translateX(-50%);z-index:300;font-size:1.6rem;font-weight:900;color:'+(c||'#fff')+';text-shadow:0 4px 20px rgba(0,0,0,.6);pointer-events:none';d.textContent=t;document.body.appendChild(d);setTimeout(function(){d.remove()},1500)}
function confetti(n){var ct=document.getElementById('confetti-box'),cl=['#f472b6','#22d3ee','#a3e635','#fbbf24','#d946ef','#f97316','#34d399'];for(var i=0;i<n;i++){var p=document.createElement('div');p.className='cf';p.style.cssText='left:'+Math.random()*100+'%;background:'+cl[Math.floor(Math.random()*cl.length)]+';animation-delay:'+Math.random()*2+'s;animation-duration:'+(2+Math.random()*2)+'s;width:'+(6+Math.random()*8)+'px;height:'+(6+Math.random()*8)+'px;border-radius:'+(Math.random()>.5?'50%':'2px');ct.appendChild(p);setTimeout(function(el){el.remove()},5000,p)}}
async function goHome(){clr();try{if(GC){if(isHost)await sb.from('quiz_players').delete().eq('game_code',GC);else if(myId)await sb.from('quiz_players').delete().eq('id',myId)}}catch(e){}GC='';isHost=false;myName='';myId=null;myScore=0;myCC=0;myTT=0;qi=0;pAns=false;lastH='';myPW={extend:false,auto:false,eliminate:false};var u=new URL(location.href);u.searchParams.delete('join');history.replaceState({},'',u);if(adminId){loadDashboard()}else{scr('scr-role')}}
// === IMPORT ===
var impTab='paste',impRows=[];
function openImport(){document.getElementById('import-modal').classList.remove('hidden');impRows=[];setImpTab('paste')}
function closeImport(){document.getElementById('import-modal').classList.add('hidden')}
function setImpTab(t){impTab=t;document.getElementById('imp-tab-paste').className='tab-btn'+(t==='paste'?' active':'');document.getElementById('imp-tab-excel').className='tab-btn'+(t==='excel'?' active':'');document.getElementById('imp-paste-box').classList.toggle('hidden',t!=='paste');document.getElementById('imp-excel-box').classList.toggle('hidden',t!=='excel')}
function parsePaste(){var txt=document.getElementById('imp-text').value.trim();if(!txt)return[];var lines=txt.split('\n');var rows=[];lines.forEach(function(l){l=l.trim();if(!l)return;var sep=l.includes('\t')?'\t':'|';var parts=l.split(sep).map(function(s){return s.trim()});if(parts.length>=6){var ci=parseInt(parts[5]);if(ci>=1&&ci<=4)rows.push({q:parts[0],a:parts[1],b:parts[2],c:parts[3],d:parts[4],correct:ci-1})}});return rows}
function parseFile(input){if(!input.files||!input.files[0])return;var file=input.files[0];var ext=file.name.split('.').pop().toLowerCase();if(ext==='csv'){var reader=new FileReader();reader.onload=function(e){var lines=e.target.result.split('\n');impRows=[];var start=0;if(lines[0]&&(lines[0].includes('Ø§Ù„Ø³Ø¤Ø§Ù„')||lines[0].toLowerCase().includes('question')))start=1;for(var i=start;i<lines.length;i++){var l=lines[i].trim();if(!l)continue;var p=l.split(',').map(function(s){return s.trim().replace(/^"|"$/g,'')});if(p.length>=6){var ci=parseInt(p[5]);if(ci>=1&&ci<=4)impRows.push({q:p[0],a:p[1],b:p[2],c:p[3],d:p[4],correct:ci-1})}}showPreview()};reader.readAsText(file)}
  else{var reader=new FileReader();reader.onload=async function(e){try{var sc=document.createElement('script');sc.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';sc.onload=function(){var wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});var ws=wb.Sheets[wb.SheetNames[0]];var data=XLSX.utils.sheet_to_json(ws,{header:1});impRows=[];var start=0;if(data[0]&&typeof data[0][0]==='string'&&(data[0][0].includes('Ø§Ù„Ø³Ø¤Ø§Ù„')||data[0][0].toLowerCase().includes('question')))start=1;for(var i=start;i<data.length;i++){var r=data[i];if(r&&r.length>=6){var ci=parseInt(r[5]);if(ci>=1&&ci<=4)impRows.push({q:String(r[0]||''),a:String(r[1]||''),b:String(r[2]||''),c:String(r[3]||''),d:String(r[4]||''),correct:ci-1})}}showPreview()};document.head.appendChild(sc)}catch(err){document.getElementById('imp-preview').innerHTML='<p class="text-red-400 text-sm">âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù</p>'}};reader.readAsArrayBuffer(file)}}
function showPreview(){document.getElementById('imp-preview').innerHTML='<p class="text-emerald-400 text-sm mb-2">âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ '+impRows.length+' Ø³Ø¤Ø§Ù„</p>'+impRows.slice(0,3).map(function(r,i){return '<p class="text-purple-300 text-xs truncate">'+(i+1)+'. '+r.q+'</p>'}).join('')+(impRows.length>3?'<p class="text-purple-400 text-xs">...Ùˆ '+(impRows.length-3)+' Ø£Ø³Ø¦Ù„Ø© Ø£Ø®Ø±Ù‰</p>':'')}
async function doImport(){var rows=impTab==='paste'?parsePaste():impRows;if(!rows.length){floatTxt('âŒ Ù„Ø§ Ø£Ø³Ø¦Ù„Ø©','#f87171');return}
  var count=0;for(var i=0;i<rows.length;i++){var r=rows[i];if(!r.q)continue;var res=await sb.from('quiz_questions').insert({game_id:curGameId,question_text:r.q,option_a:r.a,option_b:r.b,option_c:r.c,option_d:r.d,correct_option:r.correct,sort_order:gameQuestions.length+i}).select().single();if(!res.error){gameQuestions.push(res.data);count++}}
  closeImport();renQs();floatTxt('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ '+count+' Ø³Ø¤Ø§Ù„','#34d399')}
</script></body></html>
